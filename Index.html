<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>QUIZYATRA - Quiz Se Kro Success Yatra</title>
  <!-- Cropper.js CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
  <style>
    /* --- Base & Theme Variables --- */
    :root {
      --primary-bg: #f0f4f8;
      --secondary-bg: #ffffff;
      --component-bg: #f8f9fa;
      --text-color: #333;
      --border-color: #dee2e6;
      --shadow-color: rgba(0, 0, 0, 0.08);
      --accent-color: #007bff;
      --accent-hover: #0056b3;
      --correct-color: #28a745;
      --incorrect-color: #dc3545;
      --skipped-color: #ffc107;
      --bookmark-color: #a5a5a5;
      --bookmarked-active-color: #ffb300;
      --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body.dark-mode {
      --primary-bg: #121212;
      --secondary-bg: #1e1e1e;
      --component-bg: #2a2a2e;
      --text-color: #e0e0e0;
      --border-color: #44474b;
      --shadow-color: rgba(255, 255, 255, 0.08);
      --accent-color: #4dabf7;
      --accent-hover: #1c7ed6;
    }

    /* --- General Styles --- */
    body {
      font-family: var(--font-family);
      background-color: var(--primary-bg);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    .container {
      width: 100%;
      max-width: 800px;
      background-color: var(--secondary-bg);
      border-radius: 10px;
      box-shadow: 0 4px 15px var(--shadow-color);
      overflow: hidden;
      transition: background-color 0.3s, opacity 0.4s ease;
      margin-bottom: 20px;
      padding: 2rem 2.5rem;
    }

    .container.fade-out {
        opacity: 0;
    }

    .header {
      background-color: var(--accent-color);
      color: white;
      padding: 15px 20px;
      text-align: center;
      font-size: 1.5em;
      position: relative;
      margin: -2rem -2.5rem 2rem -2.5rem; /* Adjust to fit padding */
      border-radius: 10px 10px 0 0;
    }
    body.dark-mode .header { background-color: #1f1f1f; border-bottom: 1px solid var(--border-color); }
    
    .header-branding {
        font-size: 1em;
        display: inline-flex;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
        gap: 0.2em 0.6em;
    }
    .header-branding strong {
        font-size: 1.1em;
        letter-spacing: 0.5px;
    }
    .header-branding .tagline {
        font-size: 0.7em;
        opacity: 0.9;
        font-weight: 400;
        margin-top: 0.2em;
    }


    .hidden { display: none !important; }

    /* --- Animations & Effects --- */
    .fade-in-slide-up {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out;
    }
    .fade-in-slide-up:not(.hidden) {
        opacity: 1;
        transform: translateY(0);
    }

    @keyframes glow { 
        0% { box-shadow: 0 0 4px var(--accent-color); } 
        50% { box-shadow: 0 0 16px var(--accent-color), 0 0 24px var(--accent-hover); } 
        100% { box-shadow: 0 0 4px var(--accent-color); } 
    }
    .btn.glowing { animation: glow 1.8s infinite; }
    
    /* --- Loading Overlay --- */
    #loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        z-index: 3000;
        color: white;
        font-size: 1.2em;
        text-align: center;
    }
    .spinner {
        border: 6px solid rgba(255, 255, 255, 0.3);
        border-top: 6px solid var(--accent-color);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    #loading-text { font-weight: bold; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


    /* --- CREATION METHOD SELECTOR --- */
    #creation-method-selector { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-top: 2rem; }
    .creation-option-card { background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; text-align: center; cursor: pointer; transition: all 0.2s ease-in-out; }
    .creation-option-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px var(--shadow-color); border-color: var(--accent-color); }
    .creation-option-card .card-icon { font-size: 2.5rem; display: block; margin-bottom: 0.5rem; }
    .creation-option-card h4 { margin: 0.5rem 0; color: var(--accent-color); font-size: 1.1em; }
    .creation-option-card p { font-size: 0.9em; color: var(--text-color); opacity: 0.8; margin: 0; }
    @media (max-width: 600px) { #creation-method-selector { grid-template-columns: 1fr; gap: 1rem; } .creation-option-card { padding: 1rem; } }


    /* --- GENERATOR STYLES --- */
    .step-header-container { display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border-color); margin-bottom: 1.5rem; }
    .step-header { padding-bottom: 10px; margin: 2rem 0 0 0; border-bottom: none; }
    .input-group { margin-bottom: 1.5rem; }
    .input-label { display: block; margin-bottom: 8px; font-weight: bold; }
    .input-label-group { display: flex; justify-content: space-between; align-items: center; }
    textarea, .input-field, select.input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); border-radius: 5px; box-sizing: border-box; background-color: var(--component-bg); color: var(--text-color); font-family: var(--font-family); font-size: 1em; resize: vertical; }
    select.input-field { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right .75rem center; background-size: 16px 12px; }
    body.dark-mode select.input-field { background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23e0e0e0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e"); }
    #quiz-data-input, #source-text-input, #source-text-image { min-height: 250px; }

    #paste-notification { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background-color: var(--correct-color); color: white; padding: 10px 20px; border-radius: 25px; font-size: 1em; font-weight: bold; opacity: 0; transition: opacity 0.5s ease, top 0.5s ease; pointer-events: none; z-index: 2100; }
    #paste-notification.show { top: 40px; opacity: 1; }
    .prompt-actions-row { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }

    /* --- PDF/IMAGE WORKFLOW STYLES --- */
    #image-input-area, #pdf-input-area { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 1.5rem; }
    #image-preview-container { display: flex; flex-wrap: wrap; gap: 15px; width: 100%; margin-top: 1rem; min-height: 100px; border: 2px dashed var(--border-color); padding: 10px; border-radius: 5px;}
    .img-preview-wrapper { position: relative; width: 120px; height: 120px; border: 1px solid var(--border-color); border-radius: 5px; overflow: hidden; display: flex; flex-direction: column; justify-content: space-between; background-color: var(--component-bg); }
    .img-preview-wrapper .img-container { width: 100%; height: 100%; flex-grow: 1; display: flex; align-items: center; justify-content: center; overflow: hidden; }
    .img-preview-wrapper img { max-width: 100%; max-height: 100%; object-fit: contain; }
    .img-preview-actions { display: flex; justify-content: space-around; background-color: rgba(0,0,0,0.4); padding: 4px 0; }
    .img-preview-btn { background: none; border: none; color: white; cursor: pointer; font-size: 1.2rem; }
    .img-preview-btn:hover { color: var(--accent-color); }

    #ocr-status, #pdf-status { margin-top: 1rem; font-style: italic; color: var(--accent-color); font-weight: bold;}
    .page-range-container { display: flex; align-items: center; gap: 10px; }
    .page-range-container input[type="number"] { width: 80px; }

    /* --- Image Format Guide --- */
    #image-format-guide { display: flex; gap: 1.5rem; margin-top: 1rem; margin-bottom: 1.5rem; opacity: 0; transform: translateY(20px); transition: opacity 0.5s ease-out, transform 0.5s ease-out; }
    #image-format-guide:not(.hidden) { opacity: 1; transform: translateY(0); }
    .guide-card { flex: 1; background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1rem; text-align: center; }
    .guide-card.good { border-left: 4px solid var(--correct-color); }
    .guide-card.bad { border-left: 4px solid var(--incorrect-color); }
    .guide-card h5 { margin: 0 0 0.5rem 0; font-size: 1em; }
    .guide-card p { font-size: 0.85em; margin: 0; line-height: 1.4; opacity: 0.9; }
    .guide-card svg { width: 100%; height: 80px; margin-bottom: 0.5rem; }
    @media (max-width: 600px) { #image-format-guide { flex-direction: column; gap: 1rem; } }


    /* --- QUIZ PLAYER & RESULTS --- */
    #quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px dashed var(--border-color); gap: 1rem; flex-wrap: wrap; }
    #question-topic { font-weight: bold; color: var(--accent-color); font-size: 1.1rem; flex-shrink: 0; }
    #progress { background-color: var(--accent-color); color: white; padding: 5px 12px; border-radius: 15px; font-size: 0.9rem; font-weight: bold; white-space: nowrap; }
    #timer { font-weight: bold; background: var(--component-bg); padding: 8px 15px; border-radius: 25px; border: 2px solid var(--border-color); display: flex; align-items: center; gap: 10px; position: relative; width: auto; justify-content: center; }
    #timer-text { font-size: 1.4em; font-weight: bold; color: var(--accent-color); width: 60px; text-align: center; }
    body.dark-mode #timer-text { color: var(--accent-color); }
    .timer-face { font-size: 1.6rem; display: none; }
    .timer-face.visible { display: inline-block; animation: face-pop 0.4s ease-out; }
    @keyframes face-pop { 0% { transform: scale(0.5); opacity: 0; } 80% { transform: scale(1.1); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #question-image-container { margin-bottom: 1rem; }
    #question-image-container img { max-width: 100%; max-height: 400px; border-radius: 8px; display: block; margin: auto; border: 1px solid var(--border-color); }
    #question-and-bookmark { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 1rem; }
    #question-text-container { flex-grow: 1; }
    #question-text { font-size: 1.4em; font-weight: 500; margin: 0; }
    #bookmark-btn { background: none; border: 1px solid var(--border-color); color: var(--bookmark-color); font-size: 1.5rem; cursor: pointer; border-radius: 50%; width: 44px; height: 44px; flex-shrink: 0; display: flex; justify-content: center; align-items: center; transition: all 0.2s ease; }
    #bookmark-btn:hover { background-color: var(--component-bg); transform: scale(1.1); }
    #bookmark-btn.bookmarked { color: white; background-color: var(--bookmarked-active-color); border-color: var(--bookmarked-active-color); }
    #statements-list p { margin: 0.5em 0; background: var(--component-bg); padding: 10px; border-radius: 5px; border-left: 3px solid var(--accent-color); }
    .option { position: relative; border: 2px solid var(--border-color); padding: 12px 15px; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: space-between; }
    .option:hover:not(.disabled) { border-color: var(--accent-hover); background-color: var(--component-bg); }
    .option.selected { border-color: var(--accent-color); background-color: #eaf5ff; }
    body.dark-mode .option.selected { background-color: #36363c; }
    .option.correct { border-color: var(--correct-color); background-color: #e9f7ef; color: #145a32; font-weight: bold; }
    body.dark-mode .option.correct { background-color: #1c3c24; color: #a3d9b1; }
    .option.incorrect { border-color: var(--incorrect-color); background-color: #fbeee6; color: #943126; font-weight: bold; }
    body.dark-mode .option.incorrect { background-color: #4a1c20; color: #f1b0b7; }
    .option.disabled { pointer-events: none; opacity: 0.8; }
    .option-feedback { display: flex; align-items: center; gap: 10px; }
    .feedback-icon { font-size: 1.5rem; transform: scale(0); animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji { font-size: 1.5rem; display: none; animation: pop-in 0.5s ease-out forwards; }
    .user-choice-emoji.visible { display: inline-block; }
    @keyframes pop-in { 0% { transform: scale(0); opacity: 0; } 70% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
    #explanation-container { margin-top: 1.5rem; padding: 1rem; background-color: var(--component-bg); border-left: 5px solid var(--accent-color); border-radius: 5px; }
    #explanation-container h4 { margin-top: 0; }
    #quiz-actions { margin-top: 2rem; display: flex; flex-direction: column; gap: 0.75rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem; }
    .quiz-actions-row { display: flex; justify-content: space-between; align-items: center; width: 100%; }
    .quiz-actions-row-bottom { justify-content: center; }
    .btn { background-color: var(--accent-color); color: white; padding: 8px 18px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.9em; font-weight: 600; text-align: center; transition: all 0.3s; margin: 5px; display: inline-flex; align-items: center; justify-content: center; gap: 6px; width: auto; flex-grow: 0; min-width: 100px; }
    
    .btn-full-width { width: 100%; margin: 10px 0; padding: 12px 18px; flex-grow: 1; }
    .btn:hover:not(:disabled) { background-color: var(--accent-hover); box-shadow: 0 4px 8px var(--shadow-color); transform: translateY(-2px); }
    .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; opacity: 0.7; }
    body.dark-mode .btn:disabled { background-color: #555; }
    .btn-secondary { background-color: #6c757d; }
    .btn-secondary:hover:not(:disabled) { background-color: #5a6268; }
    .btn-danger { background-color: var(--incorrect-color); }
    .btn-danger:hover:not(:disabled) { background-color: #c82333; }
    #check-answer-btn { background-color: var(--correct-color); }
    #check-answer-btn:hover:not(:disabled) { background-color: #218838; }
    #skip-question-btn { background-color: var(--skipped-color); color: #212529;}
    #skip-question-btn:hover:not(:disabled) { background-color: #e0a800; }
    .exam-buttons-container, .ai-platform-selector { display: flex; flex-wrap: wrap; gap: 8px; }
    .ai-platform-selector { justify-content: center; margin-top: 10px; }
    .exam-btn, .ai-platform-btn { background-color: var(--component-bg); color: var(--text-color); border: 1px solid var(--border-color); padding: 6px 14px; font-size: 0.85em; min-width: auto; margin: 0; flex-grow: 1; }
    .exam-btn:hover:not(:disabled), .ai-platform-btn:hover:not(:disabled) { background-color: var(--primary-bg); border-color: var(--accent-color); transform: translateY(-1px); box-shadow: none; }
    .exam-btn.active, .ai-platform-btn.active { background-color: var(--accent-color); color: white; border-color: var(--accent-color); transform: none; box-shadow: none; }
    .ai-platform-option { display: flex; flex-direction: column; flex: 1; text-align: center; }
    .ai-tip { font-size: 0.8em; color: #6c757d; margin-top: 5px; }
    body.dark-mode .ai-tip { color: #aaa; }
    #results-screen h2 { color: var(--correct-color); border-bottom-color: var(--correct-color); }
    #score-summary { font-size: 1.5rem; font-weight: bold; text-align: center; margin-bottom: 1.5rem; }
    #quiz-summary-details { background-color: var(--component-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem; margin-bottom: 2rem; display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    .summary-item { display: flex; flex-direction: column; }
    .summary-label { font-size: 0.9em; color: #6c757d; font-weight: 500;}
    .summary-value { font-size: 1.2em; font-weight: bold; }
    .summary-value.remark { color: var(--accent-color); }
    body.dark-mode .summary-label { color: #aaa; }
    .result-item { border: 1px solid var(--border-color); padding: 1rem; margin-bottom: 1rem; border-radius: 8px; background-color: var(--component-bg); }
    .result-item .result-question { font-weight: bold; position: relative; }
    .bookmark-indicator { color: var(--bookmarked-active-color); font-size: 1.2rem; position: absolute; top: 0; right: 0; opacity: 0; transition: opacity 0.3s; }
    .bookmark-indicator.visible { opacity: 1; }
    .result-options-list { margin-top: 1rem; padding-left: 0; list-style-type: none; }
    .result-option { padding: 8px; border-radius: 4px; margin-bottom: 5px; border: 1px solid transparent; }
    .result-option.user-selected { border-color: var(--accent-color); }
    .result-option.correct-answer { background-color: #d4edda; }
    body.dark-mode .result-option.correct-answer { background-color: #1c3c24; }
    .result-explanation { margin-top: 1rem; padding: 1rem; background-color: var(--primary-bg); border-left: 4px solid var(--accent-color); border-radius: 5px; font-size: 0.95em; }
    .result-explanation h5 { margin-top: 0; }
    .share-buttons { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; justify-content: center; align-items: center;}
    .share-buttons-row { display: flex; gap: 10px; justify-content: center; width: 100%; flex-wrap: wrap; }
    #results-page-telegram-opener { width: 100%; max-width: 400px; }
    .telegram-input-group { display: flex; gap: 10px; align-items: center; }
    .telegram-input-group .input-field { flex-grow: 1; margin: 0; padding: 12px; border-radius: 5px; border: 1px solid var(--border-color); background-color: var(--component-bg); color: var(--text-color);}
    .telegram-input-group .btn { flex-grow: 0; padding: 12px 15px; margin: 0; }
    #theme-toggle-btn { position: absolute; top: 50%; transform: translateY(-50%); right: 20px; background: none; border: 1px solid rgba(255, 255, 255, 0.7); color: white; width: 40px; height: 40px; border-radius: 50%; font-size: 1.5rem; cursor: pointer; transition: all 0.3s ease; display: flex; justify-content: center; align-items: center; }
    #theme-toggle-btn:hover { background-color: rgba(255, 255, 255, 0.2); transform: translateY(-50%) rotate(15deg) scale(1.1); }

    /* --- GUIDE BUTTON & MODAL STYLES --- */
    .guide-container { display: flex; flex-direction: column; align-items: center; }
    .guide-help-text { font-size: 0.7em; font-weight: 500; opacity: 0.7; margin-top: -2px; user-select: none; }
    .guide-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 5px; line-height: 1; opacity: 0.7; transition: opacity 0.2s, transform 0.2s; animation: pulse 2.5s infinite ease-in-out; }
    .guide-btn:hover { opacity: 1; transform: scale(1.2); animation-play-state: paused; }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
    
    #telegram-backup-guide-container { display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 15px; }
    #telegram-backup-guide-btn { background: none; border: none; font-size: 2rem; cursor: pointer; opacity: 0.7; transition: opacity 0.2s; }
    #telegram-backup-guide-btn:hover { opacity: 1; }
    #telegram-backup-guide-container p { font-size: 0.8em; color: var(--text-color); opacity: 0.8; margin: 0; text-align: center; }

    #flowchart-modal-content {
        width: 100%;
        max-height: 65vh; /* Limit height */
        overflow-y: auto; /* Add scroll for long content */
        padding-right: 15px; /* Space for scrollbar */
    }
    .guide-step {
        background-color: var(--component-bg);
        border-left: 4px solid var(--accent-color);
        padding: 1rem;
        margin-bottom: 1.5rem;
        border-radius: 5px;
    }
    .guide-step strong {
        font-size: 1.1em;
        display: block;
        margin-bottom: 0.5em;
        color: var(--accent-color);
    }
    .guide-step p {
        margin: 0.5em 0;
        line-height: 1.5;
        font-size: 0.95em;
    }
    .guide-step .hindi-text {
        font-style: italic;
        opacity: 0.9;
        font-size: 0.9em;
        color: var(--text-color);
    }
    .modal-close-btn-top {
        position: absolute;
        top: 10px;
        right: 15px;
        background: none;
        border: none;
        font-size: 2rem;
        line-height: 1;
        cursor: pointer;
        color: var(--text-color);
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
    }
    .modal-close-btn-top:hover {
        opacity: 1;
        transform: scale(1.1);
    }


    /* --- Fallback & Redundancy Styles --- */
    #ai-link-fallback {
        background-color: var(--primary-bg);
        border: 2px dashed var(--accent-color);
        border-radius: 8px;
        padding: 1rem;
        text-align: center;
        margin-top: 1rem;
    }
    #ai-link-fallback p { margin: 0 0 0.5rem 0; }
    #ai-link-fallback a { font-weight: bold; }


    /* --- MODAL STYLES --- */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 2000; opacity: 0; transition: opacity 0.3s ease; pointer-events: none; }
    .modal-overlay:not(.hidden) { opacity: 1; pointer-events: auto; }
    .modal-content { position: relative; background-color: var(--secondary-bg); color: var(--text-color); padding: 1.5rem; border-radius: 10px; width: 90%; max-width: 800px; box-shadow: 0 5px 20px rgba(0,0,0,0.2); transform: scale(0.95); transition: transform 0.3s ease; display: flex; flex-direction: column; max-height: 90vh; }
    .modal-overlay:not(.hidden) .modal-content { transform: scale(1); }
    .modal-content h3 { margin-top: 0; color: var(--accent-color); padding-right: 30px; } /* Add padding for close button */
    #manual-copy-modal-content h3 { color: var(--incorrect-color); }
    #crop-image-container { width: 100%; flex-grow: 1; overflow: hidden; }
    #crop-image-container img { max-width: 100%; max-height: 100%; }
    .modal-actions { margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px; flex-shrink: 0; border-top: 1px solid var(--border-color); padding-top: 1rem;}
    .modal-content textarea { width: 100%; min-height: 200px; max-height: 50vh; margin-top: 1rem; margin-bottom: 1.5rem; font-family: monospace; font-size: 0.9em; background-color: var(--primary-bg); border: 1px solid var(--border-color); color: var(--text-color); padding: 10px; box-sizing: border-box; border-radius: 5px; }
  </style>
</head>
<body>

<div id="loading-overlay" class="hidden">
    <div class="spinner"></div>
    <p id="loading-text"></p>
</div>

<div id="paste-notification"></div>

<!-- ======================================= -->
<!-- ===== GENERATOR CONTAINER (MAIN) ==== -->
<!-- ======================================= -->
<div class="container" id="manual-generator-container">
    <div class="header">
        <span class="header-branding">✍️ <strong>QUIZYATRA</strong> - <span class="tagline">Quiz Se Kro Success Yatra</span></span>
        <button id="theme-toggle-btn" title="Toggle Dark/Light Mode">🌙</button>
    </div>
    <div id="manual-generator-screen">
        <p>Hi! I’m your Quiz Genie 🧞‍♂️. How would you like to create your quiz?</p>

        <div id="creation-method-selector">
            <div class="creation-option-card" id="select-from-topic">
                <span class="card-icon">📝</span><h4>Generate from Topic</h4><p>Provide a topic for the AI.</p>
            </div>
            <div class="creation-option-card" id="select-from-text">
                <span class="card-icon">📋</span><h4>Generate from Text</h4><p>Paste text to create questions.</p>
            </div>
            <div class="creation-option-card" id="select-from-image">
                <span class="card-icon">🖼️</span><h4>Generate from Image</h4><p>Use images of text for a quiz.</p>
            </div>
            <div class="creation-option-card" id="select-from-pdf">
                <span class="card-icon">📄</span><h4>Generate from PDF</h4><p>Upload a PDF to create a quiz.</p>
            </div>
        </div>

        <!-- WORKFLOW 1: From Topic -->
        <div id="topic-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Define Your Quiz</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="topic-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">help me</span>
              </div>
            </div>
            <div class="input-group"><label for="prompt-topic" class="input-label">Quiz Topic (Required)</label><input type="text" id="prompt-topic" class="input-field" placeholder="e.g., The Solar System, World War II"></div>
            <div class="input-group"><label for="prompt-num-questions-topic" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-topic" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
            <div class="input-group"><label for="prompt-subject-topic" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-topic" class="input-field" placeholder="e.g., Science, History"></div>
            <div class="input-group"><label for="prompt-language-topic" class="input-label">Quiz Language</label><select id="prompt-language-topic" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-topic" class="input-label">Difficulty Level</label><select id="prompt-difficulty-topic" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
            <div class="input-group"><label for="question-format-select-topic" class="input-label">Question Format</label><select id="question-format-select-topic" class="input-field"></select></div>
            <button id="generate-prompt-btn-topic" class="btn btn-full-width glowing">Generate Prompt & Open AI 🚀</button>
            <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
        </div>

        <!-- WORKFLOW 2: From Text -->
        <div id="text-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Provide Your Text</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">help me</span>
              </div>
            </div>
            <div class="input-group"><label for="source-text-input" class="input-label">Paste your source text below</label><textarea id="source-text-input" placeholder="Paste the content you want to create a quiz from..."></textarea></div>
            <div class="step-header-container">
              <h3 class="step-header">Step 2: Define Your Quiz</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="text-step2" title="Show Guide">💁</button>
                  <span class="guide-help-text">help me</span>
              </div>
            </div>
            <div class="input-group"><label for="prompt-num-questions-text" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-text" class="input-field" placeholder="e.g., 5" min="1" max="50"></div>
            <div class="input-group"><label for="prompt-subject-text" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-text" class="input-field" placeholder="e.g., Science, History"></div>
            <div class="input-group"><label for="prompt-language-text" class="input-label">Quiz Language</label><select id="prompt-language-text" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
            <div class="input-group"><label for="prompt-difficulty-text" class="input-label">Difficulty Level</label><select id="prompt-difficulty-text" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
            <div class="input-group"><label for="question-format-select-text" class="input-label">Question Format</label><select id="question-format-select-text" class="input-field"></select></div>
            <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
            <button id="generate-prompt-btn-text" class="btn btn-full-width glowing">Generate Prompt & Open AI 🚀</button>
            <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
        </div>

        <!-- WORKFLOW 3: From Image -->
        <div id="image-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            
            <div id="image-format-guide" class="hidden">
                <div class="guide-card good">
                    <h5>✅ Good Example</h5>
                    <svg viewBox="0 0 100 120" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="90" height="110" rx="5" fill="var(--component-bg)" stroke="var(--correct-color)" stroke-width="3"/>
                        <path d="M20 25 h60 M20 40 h60 M20 55 h60 M20 70 h40 M20 85 h60" stroke="var(--text-color)" stroke-width="2" />
                    </svg>
                    <p>Image is <strong>upright</strong> (portrait) and the text is <strong>clear</strong>.</p>
                </div>
                <div class="guide-card bad">
                    <h5>❌ Bad Example</h5>
                    <svg viewBox="0 0 120 100" xmlns="http://www.w3.org/2000/svg">
                        <rect x="5" y="5" width="110" height="90" rx="5" fill="var(--component-bg)" stroke="var(--incorrect-color)" stroke-width="3"/>
                        <path d="M25 20 v60 M40 20 v60 M55 20 v60 M70 20 v40 M85 20 v60" stroke="var(--text-color)" stroke-width="2" stroke-dasharray="3 3"/>
                    </svg>
                    <p>Image is <strong>sideways</strong> (landscape) or the text is <strong>blurry</strong>.</p>
                </div>
            </div>

            <div class="step-header-container">
              <h3 class="step-header">Step 1: Add Your Images</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="image-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">help me</span>
              </div>
            </div>
            <div id="image-input-area"><button id="select-images-btn" class="btn btn-secondary glowing">📂 Select Images</button><input type="file" id="image-file-input" multiple accept="image/*" class="hidden"></div>
            <div id="image-preview-container"></div>
            
            <button id="extract-text-btn" class="btn btn-full-width hidden" style="margin-top: 1.5rem;">🔍 Extract Text from Images</button>
            <div id="ocr-status"></div>

            <div id="image-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 2: Define Your Quiz</h3>
                  <div class="guide-container">
                      <button class="btn guide-btn" data-guide-id="image-step3" title="Show Guide">💁</button>
                      <span class="guide-help-text">help me</span>
                  </div>
                </div>
                <div class="input-group hidden"><label for="source-text-image" class="input-label">Extracted Text</label><textarea id="source-text-image"></textarea></div>
                <div class="input-group"><label for="prompt-num-questions-image" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-image" class="input-field" placeholder="e.g., 5" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-topic-image" class="input-label">Quiz Topic (Optional)</label><input type="text" id="prompt-topic-image" class="input-field" placeholder="e.g., Photosynthesis, The Mughal Empire"></div>
                <div class="input-group"><label for="prompt-subject-image" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-image" class="input-field" placeholder="e.g., Biology from textbook page"></div>
                <div class="input-group"><label for="prompt-language-image" class="input-label">Quiz Language</label><select id="prompt-language-image" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-image" class="input-label">Difficulty Level</label><select id="prompt-difficulty-image" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label for="question-format-select-image" class="input-label">Question Format</label><select id="question-format-select-image" class="input-field"></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
                <button id="generate-prompt-btn-image" class="btn btn-full-width glowing">Generate Prompt & Open AI 🚀</button>
                <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
            </div>
        </div>

        <!-- WORKFLOW 4: From PDF -->
        <div id="pdf-generator-workflow" class="hidden">
            <button class="btn btn-secondary back-to-selection-btn" style="margin-bottom: 1.5rem;">&larr; Back to Options</button>
            <div class="step-header-container">
              <h3 class="step-header">Step 1: Upload & Extract</h3>
              <div class="guide-container">
                  <button class="btn guide-btn" data-guide-id="pdf-step1" title="Show Guide">💁</button>
                  <span class="guide-help-text">help me</span>
              </div>
            </div>
            <div id="pdf-input-area">
                <button id="select-pdf-btn" class="btn btn-secondary glowing">📂 Select PDF</button>
                <input type="file" id="pdf-file-input" accept=".pdf" class="hidden">
                <span id="pdf-file-name" style="align-self: center; margin-left: 15px; font-style: italic;"></span>
            </div>
            <div id="pdf-options-container" class="hidden fade-in-slide-up">
                <div class="input-group">
                    <label class="input-label">Extraction Options</label>
                    <label><input type="radio" name="pdf-page-option" value="all" checked> Extract All Pages</label><br>
                    <label><input type="radio" name="pdf-page-option" value="range"> Extract Page Range</label>
                    <div id="pdf-page-range-selector" class="hidden" style="margin-top: 10px;">
                        <div class="page-range-container">
                            <label for="pdf-page-from">From:</label>
                            <input type="number" id="pdf-page-from" class="input-field" min="1">
                            <label for="pdf-page-to">To:</label>
                            <input type="number" id="pdf-page-to" class="input-field" min="1">
                        </div>
                    </div>
                </div>
                <div class="input-group">
                    <label><input type="checkbox" id="pdf-force-ocr"> Force OCR (for scanned or image-based PDFs)</label>
                </div>
                <button id="extract-text-pdf-btn" class="btn btn-full-width glowing">🔍 Extract Text from PDF</button>
                <div id="pdf-status"></div>
            </div>
             <div id="pdf-quiz-definition-area" class="hidden fade-in-slide-up">
                <div class="step-header-container">
                  <h3 class="step-header">Step 2: Define Your Quiz</h3>
                  <div class="guide-container">
                      <button class="btn guide-btn" data-guide-id="pdf-step2" title="Show Guide">💁</button>
                      <span class="guide-help-text">help me</span>
                  </div>
                </div>
                <div class="input-group hidden"><label for="source-text-pdf" class="input-label">Extracted Text</label><textarea id="source-text-pdf"></textarea></div>
                <div class="input-group"><label for="prompt-num-questions-pdf" class="input-label">Number of Questions</label><input type="number" id="prompt-num-questions-pdf" class="input-field" placeholder="e.g., 10" min="1" max="50"></div>
                <div class="input-group"><label for="prompt-topic-pdf" class="input-label">Quiz Topic (Optional)</label><input type="text" id="prompt-topic-pdf" class="input-field" placeholder="e.g., History of Ancient Rome"></div>
                <div class="input-group"><label for="prompt-subject-pdf" class="input-label">Subject Area (Optional)</label><input type="text" id="prompt-subject-pdf" class="input-field" placeholder="e.g., History, Science"></div>
                <div class="input-group"><label for="prompt-language-pdf" class="input-label">Quiz Language</label><select id="prompt-language-pdf" class="input-field"><option value="English" selected>English</option><option value="Hindi">Hindi</option><option value="Spanish">Spanish</option><option value="French">French</option><option value="German">German</option></select></div>
                <div class="input-group"><label for="prompt-difficulty-pdf" class="input-label">Difficulty Level</label><select id="prompt-difficulty-pdf" class="input-field"><option value="Easy">Easy</option><option value="Medium" selected>Medium</option><option value="Hard">Hard</option><option value="Expert">Expert</option></select></div>
                <div class="input-group"><label for="question-format-select-pdf" class="input-label">Question Format</label><select id="question-format-select-pdf" class="input-field"></select></div>
                <div class="input-group"><label class="input-label">Target Exam (Optional)</label><div class="exam-buttons-container"></div><input type="text" class="prompt-exam-other input-field hidden" placeholder="Enter custom exam name" style="margin-top: 10px;"></div>
                <button id="generate-prompt-btn-pdf" class="btn btn-full-width glowing">Generate Prompt & Open AI 🚀</button>
                <button class="btn btn-secondary btn-full-width back-to-selection-btn" style="margin-top: 1rem;">↩️ Back to Main Menu</button>
            </div>
        </div>
    </div>
</div>

<!-- ======================================= -->
<!-- ===== PASTE CONTAINER (STEP 2) ====== -->
<!-- ======================================= -->
<div class="container hidden" id="paste-quiz-container">
    <div class="header">
        <span class="header-branding">✍️ <strong>QUIZYATRA</strong> - <span class="tagline">Quiz Se Kro Success Yatra</span></span>
    </div>
    <p style="text-align: center; font-size: 1.1em;"><b>Welcome back!</b> I'm now waiting for the quiz text from the AI.</p>
    
    <div id="ai-link-fallback" class="hidden">
        <p>⚠️ It looks like the AI tab was blocked by your browser.</p>
        <a href="https://gemini.google.com" target="_blank" class="btn">Click Here to Open Gemini Manually</a>
    </div>

    <div class="input-group">
        <div class="input-label-group">
            <label for="quiz-data-input" class="input-label">Paste AI response here</label>
        </div>
        <textarea id="quiz-data-input" placeholder="I'll try to paste and start automatically when you return to this tab. If that doesn't work, just click into this box."></textarea>
    </div>
    <button id="start-manual-quiz-btn" class="btn btn-full-width">Parse & Start Quiz! 🧠</button>
</div>


<!-- QUIZ PLAYER & RESULTS -->
<div class="container hidden" id="quiz-player-container">
    <div id="quiz-header">
        <span id="question-topic"></span>
        <span id="timer">
            <span class="timer-face" id="face-happy">😊</span>
            <span class="timer-face" id="face-worried">😟</span>
            <span class="timer-face" id="face-sad">😥</span>
            <span class="timer-face" id="face-crying">😭</span>
            <span id="timer-text">00:00</span>
        </span>
        <span id="progress"></span>
    </div>
    <div id="question-image-container" class="hidden"></div>
    <div id="question-and-bookmark">
        <div id="question-text-container">
            <p id="question-text"></p>
            <div id="statements-list"></div>
        </div>
        <button id="bookmark-btn" title="Bookmark Question">⭐</button>
    </div>
    <div id="options-container"></div>
    <div id="explanation-container" class="hidden">
        <h4>Explanation</h4>
        <p id="explanation-text"></p>
    </div>
    <div id="quiz-actions"></div>
</div>
<div class="container hidden" id="results-screen">
    <div class="header"><h2>🏆 Quiz Results</h2></div>
    <div id="score-summary"></div>
    <div id="quiz-summary-details"></div>
    <div class="share-buttons">
        <div class="share-buttons-row">
            <button id="share-pdf-btn" class="btn">📄 Download PDF</button>
            <button id="copy-bookmarks-btn" class="btn" style="background-color: var(--bookmarked-active-color);">⭐ Copy Bookmarked</button>
            <button id="copy-all-btn" class="btn">📋 Copy All</button>
            <button id="share-whatsapp-btn" class="btn" style="background-color: #25D366;">💬 Share on WhatsApp</button>
        </div>
        <div id="results-page-telegram-opener">
            <div class="telegram-input-group">
                <input type="text" id="results-page-telegram-input" class="input-field" placeholder="Enter Telegram channel username...">
                <button id="results-page-open-telegram-btn" class="btn btn-secondary">Open</button>
            </div>
        </div>
        <div id="telegram-backup-guide-container">
            <button id="telegram-backup-guide-btn" title="How to backup on Telegram">🤔</button>
            <p>how to backup this bookmark question on telegram for future revision</p>
        </div>
    </div>
    <hr style="border: 0; border-top: 1px solid var(--border-color); margin: 2rem 0;">
    <h3 >Review Your Answers:</h3>
    <div id="results-review"></div>
    <button id="restart-quiz-btn" class="btn btn-full-width">🔄 Take Another Quiz</button>
</div>

<!-- MODALS -->
<div id="manual-copy-modal-overlay" class="modal-overlay hidden"><div id="manual-copy-modal-content" class="modal-content"><h3>Automatic Copy Failed</h3><p>Please manually copy the text below (it's already selected for you):</p><textarea id="manual-copy-textarea" readonly></textarea><button id="manual-copy-close-btn" class="btn">Close</button></div></div>
<div id="crop-modal-overlay" class="modal-overlay hidden">
    <div id="crop-modal-content" class="modal-content">
        <h3>Crop Image</h3>
        <div id="crop-image-container"><img id="image-to-crop" src="" alt="Image for cropping"></div>
        <div class="modal-actions"><button id="cancel-crop-btn" class="btn btn-secondary">Cancel</button><button id="save-crop-btn" class="btn">Crop & Save</button></div>
    </div>
</div>
<div id="rotate-modal-overlay" class="modal-overlay hidden">
    <div id="rotate-modal-content" class="modal-content">
        <h3>Image Orientation Check</h3>
        <p><b>Heads up!</b> This image seems to be on its side. For the best text recognition, we recommend rotating it 90° to be upright. Use the '🔄 Rotate 90°' button until the text is vertical and easy to read.</p>
        <div id="rotate-image-container" style="text-align: center; margin: 1rem 0; max-height: 50vh; overflow: auto; border: 1px solid var(--border-color); padding: 5px; border-radius: 5px;">
            <img id="image-to-rotate" src="" alt="Image for rotation" style="max-width: 100%; max-height: 45vh; object-fit: contain;">
        </div>
        <div class="modal-actions" style="justify-content: space-between;">
            <button id="skip-rotate-btn" class="btn btn-danger">Skip This Image</button>
            <div>
                <button id="rotate-image-btn" class="btn btn-secondary">🔄 Rotate 90°</button>
                <button id="save-rotated-btn" class="btn">Looks Good, Add It</button>
            </div>
        </div>
    </div>
</div>
<div id="flowchart-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn-top" title="Close guide">&times;</button>
        <h3 id="flowchart-modal-title">Step Guide</h3>
        <div id="flowchart-modal-content">
            <!-- Text-based guide will be injected here -->
        </div>
        <div class="modal-actions">
            <button id="flowchart-modal-close-btn" class="btn">Got It!</button>
        </div>
    </div>
</div>
<div id="telegram-backup-modal-overlay" class="modal-overlay hidden">
    <div class="modal-content">
        <button class="modal-close-btn-top" title="Close guide">&times;</button>
        <h3>How to Backup on Telegram</h3>
        <div id="telegram-backup-modal-content" class="guide-step">
            <p><strong>Step 1: Create a Telegram Channel</strong><br>Open Telegram, create a "New Channel". Make sure you set it to "Public" and give it a unique, easy-to-remember username (e.g., "my_upsc_notes_123").</p>
            <p><strong>Step 2: Copy Questions from Quizyatra</strong><br>On this results page, click the "⭐ Copy Bookmarked" or "📋 Copy All" button.</p>
            <p><strong>Step 3: Enter Username & Open</strong><br>Type the channel username you created (e.g., "my_upsc_notes_123") into the box above the 🤔 button and click "Open".</p>
            <p><strong>Step 4: Paste and Save</strong><br>This will open your channel in Telegram. Just paste the copied questions into the message box and send. Your notes are now saved!</p>
            <p><strong>Step 5: Revise in the Future</strong><br>To find your questions later, just open your Telegram channel and use the search function to find the topic (e.g., "Mango").</p>
        </div>
        <div class="modal-actions">
            <button id="telegram-backup-close-btn" class="btn">Okay, I Understand</button>
        </div>
    </div>
</div>

<!-- PERMISSION MODAL -->
<div id="clipboard-permission-modal-overlay" class="modal-overlay hidden">
    <div id="clipboard-permission-modal-content" class="modal-content">
        <h3>✨ Automation Helper</h3>
        <p>To make things super fast, this website can automatically paste the quiz text for you when you return from the AI.</p>
        <p>For this to work, I need your permission to read text from your clipboard. I will only do this when you're on this page and only to find quiz text.</p>
        <div class="modal-actions">
            <button id="deny-clipboard-btn" class="btn btn-secondary">No, I'll paste manually</button>
            <button id="grant-clipboard-btn" class="btn">Yes, allow auto-pasting</button>
        </div>
    </div>
</div>


<!-- SCRIPTS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.min.js"></script>
<script>pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.10.377/pdf.worker.min.js`;</script>
<script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- CONSTANTS ---
    const QUESTION_FORMATS = {
        'mcq': { name: 'Multiple Choice (MCQ)' },
        'statement': { name: 'Statement-Based' },
        'assertion-reason': { name: 'Assertion-Reason' },
        'true-false': { name: 'True/False' },
        'fill-blank': { name: 'Fill-in-the-Blank' },
        'mix': { name: 'Mixed Format' }
    };
    
    const LEGACY_FORMAT_TEXT = `Generate the quiz in plain text format only. Each question must be numbered and must include one of the following headers on the same line (e.g., "1. Multiple Choice Questions").

Strictly follow this exact structure for each question:

1. Multiple Choice Questions
Question: What is the capital of France?
Options:
a) Berlin
b) Madrid
c) Paris
d) Rome
Correct Answer: c) Paris
Explanation: Paris is the capital and most populous city of France.

2. Assertion-Reason Based Questions
Assertion (A): The sun appears yellow from Earth.
Reason (R): The Earth's atmosphere scatters shorter wavelength blue light more than longer wavelength yellow and red light.
Options:
a) Both A and R are true and R is the correct explanation of A.
b) Both A and R are true but R is not the correct explanation of A.
c) A is true but R is false.
d) A is false but R is true.
Correct Answer: a) Both A and R are true and R is the correct explanation of A.
Explanation: This phenomenon is known as Rayleigh scattering.

3. Statement-Based Questions
Question: Consider the following statements regarding photosynthesis:
* Photosynthesis primarily occurs in the chloroplasts of plant cells.
* Oxygen is released as a byproduct during photosynthesis.
* Photosynthesis converts light energy into chemical energy.
Which of the above statements are correct?
Options:
a) 1 and 2 only
b) 2 and 3 only
c) 1 and 3 only
d) 1, 2, and 3
Correct Answer: d) 1, 2, and 3
Explanation: All three statements are correct.`;

    const commonGuideAfterInput = `
        <div class="guide-step">
            <strong>Step 2: Fill Quiz Details</strong>
            <p>Fill in the details like Number of Questions, Subject, Language, Difficulty, Exam, and Question Format.</p>
            <p class="hindi-text">(चरण 2: क्विज़ का विवरण भरें - प्रश्नों की संख्या, विषय, भाषा, कठिनाई, परीक्षा और प्रश्न प्रारूप जैसे विवरण भरें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 3: Generate Prompt & Open AI</strong>
            <p>Click the big "Generate Prompt & Open AI" button. This automatically copies the instructions for the AI and opens the Gemini website in a new tab.</p>
            <p class="hindi-text">(चरण 3: 'Generate Prompt & Open AI' बटन पर क्लिक करें - यह AI के लिए निर्देश अपने आप कॉपी कर लेगा और एक नए टैब में Gemini वेबसाइट खोल देगा।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 4: Use the AI (Gemini)</strong>
            <p>In the Gemini website, just paste the prompt into the message box and send it. Wait for the AI to generate all the questions.</p>
            <p class="hindi-text">(चरण 4: AI (Gemini) का उपयोग करें - Gemini वेबसाइट में, बस प्रॉम्प्ट को मैसेज बॉक्स में पेस्ट करें और भेजें। AI द्वारा सभी प्रश्न बनाने तक प्रतीक्षा करें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 5: Copy AI's Response</strong>
            <p>After the questions are generated, copy the entire response. There are two ways to copy from Gemini: 1) Click the copy icon (like a clipboard 📋) below the answer. 2) Click the three dots (...) at the top-right of the response and select 'Copy'.</p>
            <p class="hindi-text">(चरण 5: AI की प्रतिक्रिया कॉपी करें - प्रश्न बन जाने के बाद, पूरी प्रतिक्रिया कॉपी करें। Gemini से कॉपी करने के 2 तरीके हैं: 1) उत्तर के नीचे कॉपी आइकन (📋) पर क्लिक करें। 2) प्रतिक्रिया के ऊपर-दाईं ओर तीन डॉट्स (...) पर क्लिक करें और 'कॉपी करें' चुनें।)</p>
        </div>
        <div class="guide-step">
            <strong>Step 6: Return to Quizyatra</strong>
            <p>You have two choices: 1) Simply switch tabs from Gemini back to Quizyatra. 2) On mobile, you can press your phone's 'Back' navigation button twice. The quiz will be created automatically!</p>
            <p class="hindi-text">(चरण 6: Quizyatra पर वापस आएं - आपके पास 2 विकल्प हैं: 1) बस Gemini से Quizyatra टैब पर वापस स्विच करें। 2) मोबाइल पर, आप अपने फोन का 'बैक' नेविगेशन बटन दो बार दबा सकते हैं। क्विज़ अपने आप बन जाएगा!)</p>
        </div>
    `;

    const GUIDE_DATA = {
        'topic-step1': {
            title: 'Guide: Create Quiz from Topic',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Enter Your Topic</strong>
                    <p>First, fill in the "Quiz Topic" field. For example: "World War II" or "Solar System".</p>
                    <p class="hindi-text">(चरण 1: अपना विषय दर्ज करें - सबसे पहले, "Quiz Topic" फ़ील्ड भरें। उदाहरण के लिए: "द्वितीय विश्व युद्ध" या "सौर मंडल"।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'text-step1': {
            title: 'Guide: Create Quiz from Text',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Paste Your Text</strong>
                    <p>Find any article, notes, or paragraph you want to make a quiz from. Copy that text and paste it into the big text box here.</p>
                    <p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप क्विज़ बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'text-step2': { 
            title: 'Guide: Create Quiz from Text',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Paste Your Text</strong>
                    <p>Find any article, notes, or paragraph you want to make a quiz from. Copy that text and paste it into the big text box here.</p>
                    <p class="hindi-text">(चरण 1: अपना टेक्स्ट पेस्ट करें - कोई भी लेख, नोट्स या पैराग्राफ खोजें जिससे आप क्विज़ बनाना चाहते हैं। उस टेक्स्ट को कॉपी करें और यहां बड़े टेक्स्ट बॉक्स में पेस्ट करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'image-step1': {
            title: 'Guide: Create Quiz from Image',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Upload Your Images</strong>
                    <p>Click "Select Images" and choose pictures of your book pages or notes from your gallery. Make sure the image is straight (portrait mode) and the text is clear and readable from top-to-bottom.</p>
                    <p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी गैलरी से अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। सुनिश्चित करें कि तस्वीर सीधी (पोर्ट्रेट मोड) हो और टेक्स्ट ऊपर-से-नीचे तक स्पष्ट और पठनीय हो।)</p>
                </div>
                 <div class="guide-step">
                    <strong>Step 2: Rotate and Extract Text</strong>
                    <p>If an image is sideways, the app will ask you to rotate it. Once all images are upright, click "Extract Text from Images".</p>
                    <p class="hindi-text">(चरण 2: घुमाएँ और टेक्स्ट निकालें - यदि कोई तस्वीर तिरछी है, तो ऐप आपको उसे घुमाने के लिए कहेगा। जब सभी तस्वीरें सीधी हो जाएं, तो "Extract Text from Images" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'image-step3': { 
            title: 'Guide: Create Quiz from Image', 
            content: `
                <div class="guide-step">
                    <strong>Step 1: Upload Your Images</strong>
                    <p>Click "Select Images" and choose pictures of your book pages or notes from your gallery. Make sure the image is straight (portrait mode) and the text is clear and readable from top-to-bottom.</p>
                    <p class="hindi-text">(चरण 1: अपनी इमेज अपलोड करें - "Select Images" पर क्लिक करें और अपनी गैलरी से अपनी किताब के पन्नों या नोट्स की तस्वीरें चुनें। सुनिश्चित करें कि तस्वीर सीधी (पोर्ट्रेट मोड) हो और टेक्स्ट ऊपर-से-नीचे तक स्पष्ट और पठनीय हो।)</p>
                </div>
                 <div class="guide-step">
                    <strong>Step 2: Rotate and Extract Text</strong>
                    <p>If an image is sideways, the app will ask you to rotate it. Once all images are upright, click "Extract Text from Images".</p>
                    <p class="hindi-text">(चरण 2: घुमाएँ और टेक्स्ट निकालें - यदि कोई तस्वीर तिरछी है, तो ऐप आपको उसे घुमाने के लिए कहेगा। जब सभी तस्वीरें सीधी हो जाएं, तो "Extract Text from Images" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            ` 
        },
        'pdf-step1': {
            title: 'Guide: Create Quiz from PDF',
            content: `
                <div class="guide-step">
                    <strong>Step 1: Select Your PDF</strong>
                    <p>Click "Select PDF" and choose the PDF file from your phone or computer.</p>
                    <p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p>
                </div>
                <div class="guide-step">
                    <strong>Step 2: Choose Options & Extract Text</strong>
                    <p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p>
                    <p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            `
        },
        'pdf-step2': { 
            title: 'Guide: Create Quiz from a PDF', 
            content: `
               <div class="guide-step">
                    <strong>Step 1: Select Your PDF</strong>
                    <p>Click "Select PDF" and choose the PDF file from your phone or computer.</p>
                    <p class="hindi-text">(चरण 1: अपनी PDF चुनें - "Select PDF" पर क्लिक करें और अपने फोन या कंप्यूटर से PDF फाइल चुनें।)</p>
                </div>
                <div class="guide-step">
                    <strong>Step 2: Choose Options & Extract Text</strong>
                    <p>You can extract all pages or a specific range. <strong>Important:</strong> If your PDF is a scanned copy or has images of text, check the "Force OCR" box for best results. Then click "Extract Text from PDF".</p>
                    <p class="hindi-text">(चरण 2: विकल्प चुनें और टेक्स्ट निकालें - आप सभी पृष्ठ या एक विशिष्ट रेंज निकाल सकते हैं। <strong>महत्वपूर्ण:</strong> यदि आपकी PDF एक स्कैन की हुई कॉपी है या उसमें टेक्स्ट की तस्वीरें हैं, तो सर्वोत्तम परिणामों के लिए "Force OCR" बॉक्स को चेक करें। फिर "Extract Text from PDF" पर क्लिक करें।)</p>
                </div>
                ${commonGuideAfterInput}
            ` 
        }
    };


    // --- DOM ELEMENT DICTIONARY ---
    const elements = {
        // Main Containers
        loadingOverlay: document.getElementById('loading-overlay'),
        loadingText: document.getElementById('loading-text'),
        manualGeneratorContainer: document.getElementById('manual-generator-container'),
        pasteQuizContainer: document.getElementById('paste-quiz-container'),
        quizPlayerContainer: document.getElementById('quiz-player-container'),
        resultsScreen: document.getElementById('results-screen'),

        // Generator Screen
        creationMethodSelector: document.getElementById('creation-method-selector'),
        selectFromTopicBtn: document.getElementById('select-from-topic'),
        selectFromTextBtn: document.getElementById('select-from-text'),
        selectFromImageBtn: document.getElementById('select-from-image'),
        selectFromPdfBtn: document.getElementById('select-from-pdf'),
        backToSelectionBtns: document.querySelectorAll('.back-to-selection-btn'),

        // Workflows
        topicGeneratorWorkflow: document.getElementById('topic-generator-workflow'),
        textGeneratorWorkflow: document.getElementById('text-generator-workflow'),
        imageGeneratorWorkflow: document.getElementById('image-generator-workflow'),
        pdfGeneratorWorkflow: document.getElementById('pdf-generator-workflow'),

        // Prompt Generation Buttons
        generatePromptBtnTopic: document.getElementById('generate-prompt-btn-topic'),
        generatePromptBtnText: document.getElementById('generate-prompt-btn-text'),
        generatePromptBtnImage: document.getElementById('generate-prompt-btn-image'),
        generatePromptBtnPdf: document.getElementById('generate-prompt-btn-pdf'),

        // Image Workflow
        imageFormatGuide: document.getElementById('image-format-guide'),
        selectImagesBtn: document.getElementById('select-images-btn'),
        imageFileInput: document.getElementById('image-file-input'),
        imagePreviewContainer: document.getElementById('image-preview-container'),
        extractTextBtn: document.getElementById('extract-text-btn'),
        ocrStatus: document.getElementById('ocr-status'),
        imageQuizDefinitionArea: document.getElementById('image-quiz-definition-area'),
        sourceTextImage: document.getElementById('source-text-image'),
        
        // PDF Workflow
        selectPdfBtn: document.getElementById('select-pdf-btn'),
        pdfFileInput: document.getElementById('pdf-file-input'),
        pdfFileName: document.getElementById('pdf-file-name'),
        pdfOptionsContainer: document.getElementById('pdf-options-container'),
        pdfPageRangeSelector: document.getElementById('pdf-page-range-selector'),
        pdfForceOcrCheckbox: document.getElementById('pdf-force-ocr'),
        extractTextPdfBtn: document.getElementById('extract-text-pdf-btn'),
        pdfStatus: document.getElementById('pdf-status'),
        pdfQuizDefinitionArea: document.getElementById('pdf-quiz-definition-area'),
        sourceTextPdf: document.getElementById('source-text-pdf'),

        // Paste & Parse Screen
        aiLinkFallback: document.getElementById('ai-link-fallback'),
        quizDataInput: document.getElementById('quiz-data-input'),
        startManualQuizBtn: document.getElementById('start-manual-quiz-btn'),

        // Quiz Player
        questionTopic: document.getElementById('question-topic'),
        progress: document.getElementById('progress'),
        timerText: document.getElementById('timer-text'),
        faces: { happy: document.getElementById('face-happy'), worried: document.getElementById('face-worried'), sad: document.getElementById('face-sad'), crying: document.getElementById('face-crying')},
        bookmarkBtn: document.getElementById('bookmark-btn'),
        questionText: document.getElementById('question-text'),
        statementsList: document.getElementById('statements-list'),
        optionsContainer: document.getElementById('options-container'),
        explanationContainer: document.getElementById('explanation-container'),
        explanationText: document.getElementById('explanation-text'),
        quizActions: document.getElementById('quiz-actions'),

        // Results Screen
        scoreSummary: document.getElementById('score-summary'),
        quizSummaryDetails: document.getElementById('quiz-summary-details'),
        resultsReview: document.getElementById('results-review'),
        sharePdfBtn: document.getElementById('share-pdf-btn'),
        copyBookmarksBtn: document.getElementById('copy-bookmarks-btn'),
        copyAllBtn: document.getElementById('copy-all-btn'),
        shareWhatsappBtn: document.getElementById('share-whatsapp-btn'),
        restartBtn: document.getElementById('restart-quiz-btn'),
        resultsPageTelegramInput: document.getElementById('results-page-telegram-input'),
        resultsPageOpenTelegramBtn: document.getElementById('results-page-open-telegram-btn'),
        telegramBackupGuideBtn: document.getElementById('telegram-backup-guide-btn'),

        // Modals
        pasteNotification: document.getElementById('paste-notification'),
        manualCopyModalOverlay: document.getElementById('manual-copy-modal-overlay'),
        manualCopyTextarea: document.getElementById('manual-copy-textarea'),
        manualCopyCloseBtn: document.getElementById('manual-copy-close-btn'),
        cropModalOverlay: document.getElementById('crop-modal-overlay'),
        imageToCrop: document.getElementById('image-to-crop'),
        cancelCropBtn: document.getElementById('cancel-crop-btn'),
        saveCropBtn: document.getElementById('save-crop-btn'),
        rotateModalOverlay: document.getElementById('rotate-modal-overlay'),
        imageToRotate: document.getElementById('image-to-rotate'),
        rotateImageBtn: document.getElementById('rotate-image-btn'),
        skipRotateBtn: document.getElementById('skip-rotate-btn'),
        saveRotatedBtn: document.getElementById('save-rotated-btn'),
        flowchartModalOverlay: document.getElementById('flowchart-modal-overlay'),
        flowchartModalTitle: document.getElementById('flowchart-modal-title'),
        flowchartModalContent: document.getElementById('flowchart-modal-content'),
        flowchartModalCloseBtn: document.getElementById('flowchart-modal-close-btn'),
        telegramBackupModalOverlay: document.getElementById('telegram-backup-modal-overlay'),
        telegramBackupCloseBtn: document.getElementById('telegram-backup-close-btn'),
        clipboardPermissionModalOverlay: document.getElementById('clipboard-permission-modal-overlay'),
        grantClipboardBtn: document.getElementById('grant-clipboard-btn'),
        denyClipboardBtn: document.getElementById('deny-clipboard-btn'),

        // Misc
        themeToggleBtn: document.getElementById('theme-toggle-btn'),
    };

    // --- SESSION PRESERVATION (Quiz-in-progress ONLY) ---
    const dbHelper = {
        db: null,
        dbName: 'QuizyatraDB',
        storeName: 'sessionState',
        
        async init() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(this.dbName, 1);
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains(this.storeName)) {
                        db.createObjectStore(this.storeName);
                    }
                };
                request.onsuccess = (event) => {
                    this.db = event.target.result;
                    resolve(this.db);
                };
                request.onerror = (event) => {
                    console.error('IndexedDB error:', event.target.error);
                    reject(event.target.error);
                };
            });
        },
        
        async set(key, value) {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.put(value, key);
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        },
        
        async get(key) {
            if (!this.db) await this.init();
            return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readonly');
                const store = transaction.objectStore(this.storeName);
                const request = store.get(key);
                request.onsuccess = () => resolve(request.result);
                request.onerror = (event) => reject(event.target.error);
            });
        },

        async clear() {
            if (!this.db) await this.init();
             return new Promise((resolve, reject) => {
                const transaction = this.db.transaction([this.storeName], 'readwrite');
                const store = transaction.objectStore(this.storeName);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
            });
        }
    };

    // --- STATE MANAGEMENT & SESSION ---
    const QUIZ_STATE_KEY = 'quizyatraQuizState';
    let quizData = [], originalQuizData = [], userAnswers = [];
    let quizMetaData = {};
    let currentQuestionIndex = 0, selectedOptionIndex = null;
    let bookmarkedQuestions = new Set();
    let timerId = null, quizStartTime = null, questionStartTime = null;
    let imageFiles = [];
    let rotationQueue = [];
    let currentRotationData = { file: null, rotation: 0 };
    let pdfFile = null;
    let cropper = null;
    let currentEditingImageId = null;
    let selectedExam = '';
    let ocrWorker = null;
    let ocrProgress = { currentIndex: 0, totalFiles: 0 };


    // --- INITIALIZATION ---
    async function init() {
        applyInitialTheme();
        populateSharedElements();
        setupEventListeners();
        await dbHelper.init();
        
        const quizRestored = await loadQuizState();
        if (quizRestored) {
            // Active quiz session takes precedence.
        } else if (sessionStorage.getItem('promptGenerated') === 'true') {
            showScreen('paste');
            handleClipboardPermission();
        } else {
            showScreen('manualGenerator');
        }
    }
    init();


    // --- UI & EFFECTS ---
    function showLoading(text) {
        elements.loadingText.textContent = text;
        elements.loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
        elements.loadingOverlay.classList.add('hidden');
    }
    
    function showScreen(screenName) {
        const screens = {
            manualGenerator: elements.manualGeneratorContainer,
            paste: elements.pasteQuizContainer,
            player: elements.quizPlayerContainer,
            results: elements.resultsScreen
        };
        const activeScreen = Object.values(screens).find(s => s && !s.classList.contains('hidden'));

        const switchScreens = () => {
            Object.values(screens).forEach(s => s && s.classList.add('hidden'));
            if(screens[screenName]) {
                screens[screenName].classList.remove('hidden', 'fade-out');
                if(screenName === 'manualGenerator') showCreationSelector();
            }
        };

        if (activeScreen && activeScreen !== screens[screenName]) {
            activeScreen.classList.add('fade-out');
            setTimeout(switchScreens, 300);
        } else {
            switchScreens();
        }
    }

    function showCreationSelector() { ['topic', 'text', 'image', 'pdf'].forEach(w => elements[w+'GeneratorWorkflow'].classList.add('hidden')); elements.creationMethodSelector.classList.remove('hidden'); elements.imageFormatGuide.classList.add('hidden'); }
    function showWorkflow(workflowName) {
        ['topic', 'text', 'image', 'pdf'].forEach(w => {
            const wf = elements[w+'GeneratorWorkflow'];
            if (wf) wf.classList.add('hidden');
        });
        elements.creationMethodSelector.classList.add('hidden');
        elements.imageFormatGuide.classList.add('hidden');

        if (elements[workflowName+'GeneratorWorkflow']) {
            elements[workflowName+'GeneratorWorkflow'].classList.remove('hidden');
            if (workflowName === 'image') {
                setTimeout(() => { elements.imageFormatGuide.classList.remove('hidden'); }, 50);
            }
        }
    }

    function populateSharedElements() {
        const formatSelects = document.querySelectorAll('select[id^="question-format-select"]');
        formatSelects.forEach(select => {
            if (!select) return;
            select.innerHTML = '';
            Object.keys(QUESTION_FORMATS).forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = QUESTION_FORMATS[key].name;
                select.appendChild(option);
            });
        });

        const examHtml = `<button class="btn exam-btn" data-exam-name="NEET">NEET</button><button class="btn exam-btn" data-exam-name="IIT-JEE">IIT-JEE</button><button class="btn exam-btn" data-exam-name="UPSC Civil Services">UPSC</button><button class="btn exam-btn" data-exam-name="SSC CGL">SSC</button><button class="btn exam-btn" data-exam-name="UP-SI">UP-SI</button><button class="btn exam-btn" data-exam-name="State PSC">State PSC</button><button class="btn exam-btn" data-exam-name="Banking Exams">Bank</button><button class="btn exam-btn" data-exam-name="Railway Exams">Railway</button><button class="btn exam-btn" data-exam-name="Other">Other</button>`;
        document.querySelectorAll('.exam-buttons-container').forEach(c => c.innerHTML = examHtml);
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // Main Navigation
        elements.selectFromTopicBtn.addEventListener('click', () => showWorkflow('topic'));
        elements.selectFromTextBtn.addEventListener('click', () => showWorkflow('text'));
        elements.selectFromImageBtn.addEventListener('click', () => showWorkflow('image'));
        elements.selectFromPdfBtn.addEventListener('click', () => showWorkflow('pdf'));
        elements.backToSelectionBtns.forEach(btn => btn.addEventListener('click', showCreationSelector));

        // Prompt Generation
        elements.generatePromptBtnTopic.addEventListener('click', generateTopicPrompt);
        elements.generatePromptBtnText.addEventListener('click', generateTextPrompt);
        elements.generatePromptBtnImage.addEventListener('click', generateImagePrompt);
        elements.generatePromptBtnPdf.addEventListener('click', generatePdfPrompt);

        // Image Workflow
        elements.selectImagesBtn.addEventListener('click', () => elements.imageFileInput.click());
        elements.imageFileInput.addEventListener('change', handleImageSelection);
        elements.extractTextBtn.addEventListener('click', runMultiLayerOCR);
        elements.saveCropBtn.addEventListener('click', saveCrop);
        elements.cancelCropBtn.addEventListener('click', closeCropModal);
        elements.rotateImageBtn.addEventListener('click', rotateImageInModal);
        elements.skipRotateBtn.addEventListener('click', skipImageRotation);
        elements.saveRotatedBtn.addEventListener('click', saveImageRotation);
        
        // PDF Workflow
        elements.selectPdfBtn.addEventListener('click', () => elements.pdfFileInput.click());
        elements.pdfFileInput.addEventListener('change', handlePdfSelection);
        document.querySelectorAll('input[name="pdf-page-option"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                elements.pdfPageRangeSelector.classList.toggle('hidden', e.target.value !== 'range');
            });
        });
        elements.extractTextPdfBtn.addEventListener('click', runPdfExtraction);

        // Shared Components & Fallbacks
        document.querySelectorAll('.exam-btn').forEach(btn => btn.addEventListener('click', handleExamSelection));
        
        // Guide Modal Listeners (Using Event Delegation for robustness)
        document.body.addEventListener('click', (event) => {
            const guideBtn = event.target.closest('.guide-btn');
            if (guideBtn) {
                event.preventDefault();
                showFlowchartGuide(guideBtn.dataset.guideId);
            }
            if (event.target.closest('.modal-close-btn-top')) {
                const modal = event.target.closest('.modal-overlay');
                if (modal) modal.classList.add('hidden');
            }
        });
        elements.flowchartModalCloseBtn.addEventListener('click', closeFlowchartGuide);
        elements.telegramBackupGuideBtn.addEventListener('click', () => elements.telegramBackupModalOverlay.classList.remove('hidden'));
        elements.telegramBackupCloseBtn.addEventListener('click', () => elements.telegramBackupModalOverlay.classList.add('hidden'));


        // Quiz and Results
        elements.startManualQuizBtn.addEventListener('click', startManualQuiz);
        elements.sharePdfBtn.addEventListener('click', generatePDF);
        elements.copyBookmarksBtn.addEventListener('click', () => copyQuizContent(true));
        elements.copyAllBtn.addEventListener('click', () => copyQuizContent(false));
        elements.shareWhatsappBtn.addEventListener('click', shareOnWhatsApp);
        elements.restartBtn.addEventListener('click', restartQuiz);
        elements.bookmarkBtn.addEventListener('click', handleBookmark);
        elements.resultsPageOpenTelegramBtn.addEventListener('click', openTelegramChannel);

        // Misc, Automation & Session
        elements.themeToggleBtn.addEventListener('click', toggleTheme);
        elements.manualCopyCloseBtn.addEventListener('click', () => elements.manualCopyModalOverlay.classList.add('hidden'));
        document.addEventListener('visibilitychange', handleVisibilityChange);
        window.addEventListener('beforeunload', saveQuizState);
        
        // Clipboard Permission & Automation
        elements.grantClipboardBtn.addEventListener('click', requestClipboardAndPaste);
        elements.denyClipboardBtn.addEventListener('click', () => {
            elements.clipboardPermissionModalOverlay.classList.add('hidden');
            showPasteNotification("Okay, you can paste the text yourself.");
        });
        elements.quizDataInput.addEventListener('focus', tryAutoPasteOnFocus);
    }
    
    // --- SESSION MANAGEMENT (Quiz-in-progress ONLY) ---
    async function saveQuizState() {
        if (quizData.length === 0 || elements.quizPlayerContainer.classList.contains('hidden')) {
             await dbHelper.set(QUIZ_STATE_KEY, null);
             return;
        }
        const state = {
            originalQuizData, userAnswers, currentQuestionIndex,
            bookmarkedQuestions: Array.from(bookmarkedQuestions),
            quizStartTime: quizStartTime.toISOString(),
            quizMetaData: quizMetaData
        };
        await dbHelper.set(QUIZ_STATE_KEY, state);
    }

    async function loadQuizState() {
        const state = await dbHelper.get(QUIZ_STATE_KEY);
        if (!state) return false;
        try {
            originalQuizData = state.originalQuizData;
            quizData = JSON.parse(JSON.stringify(originalQuizData));
            userAnswers = state.userAnswers;
            currentQuestionIndex = state.currentQuestionIndex;
            bookmarkedQuestions = new Set(state.bookmarkedQuestions);
            quizStartTime = new Date(state.quizStartTime);
            quizMetaData = state.quizMetaData || {};
            showScreen('player');
            loadQuestion(currentQuestionIndex);
            showPasteNotification('✅ Your active quiz has been restored.');
            return true;
        } catch (e) {
            console.error("Failed to load quiz state:", e);
            await dbHelper.set(QUIZ_STATE_KEY, null);
            return false;
        }
    }
    
    // --- CLIPBOARD PERMISSION & AUTOMATION ---
    async function handleClipboardPermission() {
        if (!navigator.clipboard || !navigator.permissions) return;
        try {
            const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" });
            if (permissionStatus.state === "granted") {
                await tryAutoPasteOnReturn();
            } else if (permissionStatus.state === "prompt") {
                elements.clipboardPermissionModalOverlay.classList.remove('hidden');
            }
        } catch (e) {
            console.warn("Clipboard permission API not supported or failed.", e);
        }
    }

    async function requestClipboardAndPaste() {
        elements.clipboardPermissionModalOverlay.classList.add('hidden');
        await tryAutoPasteOnReturn(true); // `true` forces the browser prompt
    }

    async function tryAutoPasteOnReturn(forcePrompt = false) {
        if (!forcePrompt && document.hidden) return; // Don't run if tab is not active unless forced
        try {
            const text = await navigator.clipboard.readText();
            if (text && text.trim() && (text.includes("Question:") || text.includes("Correct Answer:"))) {
                elements.quizDataInput.value = text;
                showPasteNotification('✨ Auto-pasted! Starting quiz...');
                startManualQuiz(); // This now happens immediately
            } else if (forcePrompt) {
                 showPasteNotification("📋 Your clipboard is empty or doesn't look like a quiz.");
            }
        } catch (err) {
            if (err.name !== 'NotAllowedError') {
                console.error("Clipboard read failed: ", err);
            }
            if (forcePrompt) {
                showPasteNotification("Permission denied. You can paste manually.");
            }
        }
    }
    
    async function tryAutoPasteOnFocus() {
        if(elements.quizDataInput.value.trim() !== '') return;
        try {
            const permissionStatus = await navigator.permissions.query({ name: "clipboard-read" });
            if (permissionStatus.state === "granted") {
                await tryAutoPasteOnReturn(false);
            }
        } catch (e) { /* Fail silently */ }
    }


    async function handleVisibilityChange() {
        if (!document.hidden && sessionStorage.getItem('promptGenerated') === 'true') {
            await handleClipboardPermission();
        }
    }
    
    // --- GUIDE MODAL FUNCTIONS ---
    function showFlowchartGuide(guideId) {
        const guideContent = GUIDE_DATA[guideId];
        if (guideContent) {
            elements.flowchartModalTitle.textContent = guideContent.title;
            elements.flowchartModalContent.innerHTML = guideContent.content;
            elements.flowchartModalOverlay.classList.remove('hidden');
        } else {
            console.error('No guide found for ID:', guideId);
        }
    }

    function closeFlowchartGuide() {
        elements.flowchartModalOverlay.classList.add('hidden');
    }

    // --- PROMPT BUILDER LOGIC (Centralized & Enhanced) ---
    function generatePrompt(source, sourceType) {
        const { numQuestions, topic, subject, difficulty, language, formatKey, exam } = source;
        const sourceText = sourceType === 'pdf' ? elements.sourceTextPdf.value.trim() :
                           sourceType === 'image' ? elements.sourceTextImage.value.trim() :
                           sourceType === 'text' ? document.getElementById('source-text-input').value.trim() : '';
        
        if ((sourceType !== 'topic' && !sourceText) || !numQuestions) {
            alert('Please ensure you have provided the source material and specified the number of questions.');
            return;
        }

        const formatInfo = QUESTION_FORMATS[formatKey];
        let formatRequest = `in the "${formatInfo.name}" format.`;
        if (formatKey === 'mix') { formatRequest = 'in a mix of different formats (like Multiple Choice, Statement-Based, Assertion-Reason, etc.).'; }

        let prompt = `Based ${sourceType !== 'topic' ? '*only* on the text I provide below, ' : ''}`;
        prompt += `please generate exactly ${numQuestions} question(s)`;
        if (sourceType === 'topic') prompt += ` about the topic "${topic}". `;
        else prompt += `. `;

        if (subject) prompt += `The quiz should be on the subject of "${subject}". `;
        if (exam) prompt += `The questions should be tailored for the ${exam} exam. `;
        if (language) prompt += `The quiz questions and all related content (options, explanation) MUST be in the ${language} language. `;
        prompt += `The difficulty level should be ${difficulty}. The questions must be ${formatRequest}\n\n`;
        prompt += `IMPORTANT INSTRUCTIONS:
- You MUST provide the response in plain text format only. Do not use markdown, JSON, or code blocks.
- Each question must be numbered and must include a question type header on the same line (e.g., "1. Multiple Choice Questions").
- You must provide the question, all options, the single correct answer, and a detailed explanation for each question based *only* on the provided text (if applicable).
---
HERE ARE EXAMPLES OF THE REQUIRED STRUCTURE:
${LEGACY_FORMAT_TEXT}
---
`;
        if (sourceType !== 'topic') {
            prompt += `\nNow, here is the source text to create the quiz from:\n--- START OF SOURCE TEXT ---\n${sourceText}\n--- END OF SOURCE TEXT ---`;
        }
        
        executePostPromptActions(prompt);
    }

    async function executePostPromptActions(prompt) {
        try {
            await copyTextToClipboard(prompt);
            showPasteNotification('✅ Prompt copied! Opening Gemini...');
        } catch {
             // The manual copy modal is shown by copyTextToClipboard on failure, so we just proceed
        }
        
        sessionStorage.setItem('promptGenerated', 'true');
        showScreen('paste'); 
        openAiWithFallback();
    }

    function openAiWithFallback() {
        const geminiUrl = 'https://gemini.google.com';
        const aiWindow = window.open(geminiUrl, '_blank');

        if (!aiWindow || aiWindow.closed || typeof aiWindow.closed === 'undefined') {
            showPasteNotification('⚠️ Popup blocked! Click the link to open manually.');
            elements.aiLinkFallback.classList.remove('hidden');
        } else {
            elements.aiLinkFallback.classList.add('hidden');
        }
    }
    
    function generateTopicPrompt() {
        const source = {
            numQuestions: document.getElementById('prompt-num-questions-topic').value || 5,
            topic: document.getElementById('prompt-topic').value.trim(),
            subject: document.getElementById('prompt-subject-topic').value.trim(),
            difficulty: document.getElementById('prompt-difficulty-topic').value,
            language: document.getElementById('prompt-language-topic').value,
            formatKey: document.getElementById('question-format-select-topic').value,
            exam: (selectedExam === 'Other') ? elements.topicGeneratorWorkflow.querySelector('.prompt-exam-other').value.trim() : selectedExam,
        };
        if (!source.topic) { alert('Please enter a Quiz Topic.'); return; }
        generatePrompt(source, 'topic');
    }

    function generateTextPrompt() {
        const source = {
            numQuestions: document.getElementById('prompt-num-questions-text').value,
            subject: document.getElementById('prompt-subject-text').value.trim(),
            difficulty: document.getElementById('prompt-difficulty-text').value,
            language: document.getElementById('prompt-language-text').value,
            formatKey: document.getElementById('question-format-select-text').value,
            exam: (selectedExam === 'Other') ? elements.textGeneratorWorkflow.querySelector('.prompt-exam-other').value.trim() : selectedExam,
        };
        generatePrompt(source, 'text');
    }

    function generateImagePrompt() {
        const source = {
            numQuestions: document.getElementById('prompt-num-questions-image').value,
            topic: document.getElementById('prompt-topic-image').value.trim(),
            subject: document.getElementById('prompt-subject-image').value.trim(),
            difficulty: document.getElementById('prompt-difficulty-image').value,
            language: document.getElementById('prompt-language-image').value,
            formatKey: document.getElementById('question-format-select-image').value,
            exam: (selectedExam === 'Other') ? elements.imageGeneratorWorkflow.querySelector('.prompt-exam-other').value.trim() : selectedExam,
        };
        generatePrompt(source, 'image');
    }

    function generatePdfPrompt() {
        const source = {
            numQuestions: document.getElementById('prompt-num-questions-pdf').value,
            topic: document.getElementById('prompt-topic-pdf').value.trim(),
            subject: document.getElementById('prompt-subject-pdf').value.trim(),
            difficulty: document.getElementById('prompt-difficulty-pdf').value,
            language: document.getElementById('prompt-language-pdf').value,
            formatKey: document.getElementById('question-format-select-pdf').value,
            exam: (selectedExam === 'Other') ? elements.pdfGeneratorWorkflow.querySelector('.prompt-exam-other').value.trim() : selectedExam,
        };
        generatePrompt(source, 'pdf');
    }

    function handleExamSelection(event) {
        event.preventDefault();
        const clickedBtn = event.currentTarget;
        const examName = clickedBtn.dataset.examName;
        const parentContainer = clickedBtn.closest('.exam-buttons-container');
        if (!parentContainer) return;
        const otherInput = parentContainer.nextElementSibling;
        const examButtons = parentContainer.querySelectorAll('.exam-btn');
        if (clickedBtn.classList.contains('active')) {
            clickedBtn.classList.remove('active');
            selectedExam = '';
            if (otherInput && otherInput.classList.contains('prompt-exam-other')) otherInput.classList.add('hidden');
        } else {
            examButtons.forEach(btn => btn.classList.remove('active'));
            clickedBtn.classList.add('active');
            selectedExam = examName;
            if (otherInput && otherInput.classList.contains('prompt-exam-other')) {
                otherInput.classList.toggle('hidden', examName !== 'Other');
                if (examName === 'Other') otherInput.focus();
                else otherInput.value = '';
            }
        }
    }
    
    // --- PDF WORKFLOW ---
    function handlePdfSelection(event) {
        pdfFile = event.target.files[0];
        if (pdfFile) {
            elements.pdfFileName.textContent = pdfFile.name;
            elements.pdfOptionsContainer.classList.remove('hidden');
            elements.pdfQuizDefinitionArea.classList.add('hidden');
            elements.pdfStatus.textContent = '';
        }
    }

    async function runPdfExtraction() {
        if (!pdfFile) { alert('Please select a PDF file first.'); return; }
        
        showLoading('Initializing PDF processing...');
        
        const forceOcr = elements.pdfForceOcrCheckbox.checked;
        const pageOption = document.querySelector('input[name="pdf-page-option"]:checked').value;
        let startPage = 1, endPage = Infinity;

        try {
            const loadingTask = pdfjsLib.getDocument(URL.createObjectURL(pdfFile));
            const pdf = await loadingTask.promise;
            endPage = pdf.numPages;

            if (pageOption === 'range') {
                const from = parseInt(document.getElementById('pdf-page-from').value, 10);
                const to = parseInt(document.getElementById('pdf-page-to').value, 10);
                if (!from || !to || from < 1 || to > endPage || from > to) {
                    alert('Invalid page range. Please enter valid start and end pages.');
                    hideLoading();
                    return;
                }
                startPage = from;
                endPage = to;
            }

            let fullText = '';
            if (forceOcr) {
                fullText = await extractPdfTextWithOcr(pdf, startPage, endPage);
            } else {
                fullText = await extractPdfTextNative(pdf, startPage, endPage);
            }

            elements.sourceTextPdf.value = fullText.trim();
            if(fullText.trim()){
                elements.pdfQuizDefinitionArea.classList.remove('hidden');
                elements.pdfQuizDefinitionArea.scrollIntoView({ behavior: 'smooth' });
            } else {
                 showPasteNotification(`⚠️ No text was extracted. Try with "Force OCR" checked.`);
            }

        } catch (error) {
            console.error("PDF Processing Error:", error);
            showPasteNotification(`❌ An error occurred: ${error.message}`);
        } finally {
            hideLoading();
        }
    }

    async function extractPdfTextNative(pdf, start, end) {
        let textContent = '';
        for (let i = start; i <= end; i++) {
            showLoading(`Extracting text from page ${i}... (Native)`);
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();
            textContent += content.items.map(item => item.str).join(' ') + '\n\n';
        }
        return textContent;
    }

    async function extractPdfTextWithOcr(pdf, start, end) {
        let fullText = '';
        let ocrWorker = null;
        showLoading('Initializing Advanced OCR for PDF...');

        try {
            ocrWorker = await Tesseract.createWorker('eng', 1, {
                logger: m => {
                    if (m.status === 'recognizing text') {
                        const progress = (m.progress * 100).toFixed(0);
                        showLoading(`🤖 Performing OCR on page... ${progress}%`);
                    }
                }
            });

            for (let i = start; i <= end; i++) {
                showLoading(`⏳ Rendering page ${i} of ${end} for OCR...`);
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport: viewport }).promise;

                showLoading(`🤖 Recognizing text on page ${i}...`);
                const { data: { text } } = await ocrWorker.recognize(canvas);
                fullText += text + '\n\n';
            }
        } catch (error) {
            console.error("PDF OCR Extraction Error:", error);
            showPasteNotification(`❌ OCR error on PDF: ${error.message}`);
            return fullText;
        } finally {
            if (ocrWorker) {
                await ocrWorker.terminate();
            }
        }
        return fullText;
    }


    // --- ADVANCED IMAGE & OCR WORKFLOW (for Image Section) ---
    function getImageDimensions(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    resolve({
                        width: img.naturalWidth,
                        height: img.naturalHeight,
                        file: file
                    });
                };
                img.onerror = reject;
                img.src = e.target.result;
            };
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }

    async function handleImageSelection(event) {
        const newFiles = Array.from(event.target.files);
        if (newFiles.length === 0) return;

        showLoading('Scanning images...');
        
        try {
            const dimensionPromises = newFiles.map(file => getImageDimensions(file));
            const results = await Promise.all(dimensionPromises);

            const portraitFiles = [];
            rotationQueue = [];

            results.forEach(result => {
                if (result.height > result.width) {
                    portraitFiles.push(result.file);
                } else {
                    rotationQueue.push(result.file);
                }
            });

            portraitFiles.forEach(file => addImageFile(file));

            if (rotationQueue.length > 0) {
                processRotationQueue();
            }

        } catch (error) {
            console.error("Error processing image files:", error);
            showPasteNotification('❌ Error checking image files.');
        } finally {
            hideLoading();
            event.target.value = '';
        }
    }

    function processRotationQueue() {
        if (rotationQueue.length === 0) {
            showPasteNotification('✅ All images processed.');
            return;
        }

        const fileToRotate = rotationQueue.shift();
        currentRotationData = { file: fileToRotate, rotation: 0 };
        
        elements.imageToRotate.src = URL.createObjectURL(fileToRotate);
        elements.imageToRotate.style.transform = 'rotate(0deg)';
        elements.rotateModalOverlay.classList.remove('hidden');
    }

    function rotateImageInModal() {
        currentRotationData.rotation = (currentRotationData.rotation + 90) % 360;
        elements.imageToRotate.style.transform = `rotate(${currentRotationData.rotation}deg)`;
    }
    
    function skipImageRotation() {
        elements.rotateModalOverlay.classList.add('hidden');
        processRotationQueue();
    }

    async function saveImageRotation() {
        showLoading('Rotating image...');
        const originalFile = currentRotationData.file;
        const rotation = currentRotationData.rotation;

        elements.rotateModalOverlay.classList.add('hidden');

        if (rotation === 0) {
            addImageFile(originalFile);
            hideLoading();
            processRotationQueue();
            return;
        }

        const img = new Image();
        img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const w = img.width, h = img.height;
            if (rotation === 90 || rotation === 270) { canvas.width = h; canvas.height = w; } 
            else { canvas.width = w; canvas.height = h; }
            ctx.translate(canvas.width / 2, canvas.height / 2);
            ctx.rotate(rotation * Math.PI / 180);
            ctx.drawImage(img, -w / 2, -h / 2);
            canvas.toBlob((blob) => {
                const rotatedFile = new File([blob], originalFile.name, { type: blob.type, lastModified: new Date().getTime() });
                addImageFile(rotatedFile);
                hideLoading();
                processRotationQueue();
            }, 'image/jpeg', 0.95);
        };
        img.src = URL.createObjectURL(originalFile);
    }
    
    function addImageFile(file) {
        imageFiles.push({ originalFile: file, id: `img_${Date.now()}_${Math.random()}`, croppedFile: null, previewUrl: null, });
        updateImagePreviews();
    }


    function updateImagePreviews() {
        elements.imagePreviewContainer.innerHTML = '';
        imageFiles.forEach(imgFile => {
            const fileForPreview = imgFile.croppedFile || imgFile.originalFile;
            if(imgFile.previewUrl) URL.revokeObjectURL(imgFile.previewUrl);
            imgFile.previewUrl = URL.createObjectURL(fileForPreview);
            const wrapper = document.createElement('div');
            wrapper.className = 'img-preview-wrapper';
            wrapper.innerHTML = `<div class="img-container"><img src="${imgFile.previewUrl}" alt="Image preview"></div><div class="img-preview-actions"><button class="img-preview-btn crop-btn" data-id="${imgFile.id}" title="Crop">✂️</button><button class="img-preview-btn remove-btn" data-id="${imgFile.id}" title="Remove">🗑️</button></div>`;
            elements.imagePreviewContainer.appendChild(wrapper);
        });
        document.querySelectorAll('.crop-btn').forEach(btn => btn.addEventListener('click', () => openCropModal(btn.dataset.id)));
        document.querySelectorAll('.remove-btn').forEach(btn => btn.addEventListener('click', () => removeImage(btn.dataset.id)));
        
        const hasImages = imageFiles.length > 0;
        elements.extractTextBtn.classList.toggle('hidden', !hasImages);
        if (hasImages) elements.extractTextBtn.classList.add('glowing'); else elements.extractTextBtn.classList.remove('glowing');
        elements.imageQuizDefinitionArea.classList.add('hidden');
    }

    function removeImage(idToRemove) {
        const indexToRemove = imageFiles.findIndex(f => f.id === idToRemove);
        if (indexToRemove > -1) {
            if (imageFiles[indexToRemove].previewUrl) URL.revokeObjectURL(imageFiles[indexToRemove].previewUrl);
            imageFiles.splice(indexToRemove, 1);
            updateImagePreviews();
        }
    }
    function openCropModal(imageId) {
        const imgFile = imageFiles.find(f => f.id === imageId);
        if (!imgFile) return;
        currentEditingImageId = imageId;
        const fileToCrop = imgFile.croppedFile || imgFile.originalFile;
        elements.imageToCrop.src = URL.createObjectURL(fileToCrop);
        elements.cropModalOverlay.classList.remove('hidden');
        elements.imageToCrop.onload = () => { if (cropper) cropper.destroy(); cropper = new Cropper(elements.imageToCrop, { aspectRatio: NaN, viewMode: 1, background: false, autoCropArea: 0.9, }); };
    }
    function closeCropModal() { if(cropper) cropper.destroy(); cropper = null; currentEditingImageId = null; elements.cropModalOverlay.classList.add('hidden'); }
    function saveCrop() {
        if (!cropper || !currentEditingImageId) return;
        cropper.getCroppedCanvas({ minWidth: 256, maxWidth: 4096, imageSmoothingQuality: 'high' }).toBlob((blob) => {
            const imgFile = imageFiles.find(f => f.id === currentEditingImageId);
            if(imgFile) { imgFile.croppedFile = blob; updateImagePreviews(); }
            closeCropModal();
        });
    }

    /**
     * Replaces the old multi-pass OCR with a more efficient, single-pass OCR engine
     * that provides real-time progress updates.
     */
    async function runMultiLayerOCR() {
        if (imageFiles.length === 0) {
            alert('Please select one or more images first.');
            return;
        }

        // Centralized worker initialization, runs only once.
        const initializeOcrWorker = async () => {
            if (ocrWorker) return; // Don't re-initialize
            
            showLoading('Initializing OCR Engine (first time only)...');
            try {
                ocrWorker = await Tesseract.createWorker('eng', 1, {
                    // The logger uses the ocrProgress state object to show contextual messages
                    logger: m => {
                        if (m.status === 'recognizing text') {
                            const progress = (m.progress * 100).toFixed(0);
                            showLoading(`Recognizing text in image ${ocrProgress.currentIndex + 1}/${ocrProgress.totalFiles} (${progress}%)...`);
                        }
                    },
                });
            } catch (error) {
                console.error("Failed to create Tesseract worker:", error);
                showPasteNotification("❌ Could not initialize the OCR engine.");
                hideLoading();
                throw error; // Stop execution
            }
        };

        try {
            await initializeOcrWorker(); // Ensure worker is ready

            let fullText = '';
            ocrProgress.totalFiles = imageFiles.length; // Set total for the logger to use

            for (let i = 0; i < imageFiles.length; i++) {
                ocrProgress.currentIndex = i; // Update current index for the logger
                
                const imageFile = imageFiles[i];
                const fileToProcess = imageFile.croppedFile || imageFile.originalFile;
                
                showLoading(`Preparing image ${i + 1}/${imageFiles.length}...`);
                
                // The logger inside the worker will automatically handle progress updates from here
                const { data: { text } } = await ocrWorker.recognize(fileToProcess);
                
                fullText += text + '\n\n';
            }

            elements.sourceTextImage.value = fullText.trim();
            elements.imageQuizDefinitionArea.classList.remove('hidden');
            elements.imageQuizDefinitionArea.scrollIntoView({ behavior: 'smooth' });
            showPasteNotification('✅ Text extraction complete!');

        } catch (error) {
            console.error("An error occurred during OCR processing:", error);
            showPasteNotification("❌ OCR failed. The image might be unsupported or an error occurred.");
        } finally {
            hideLoading();
            // We do NOT terminate the worker here, allowing for faster subsequent OCR runs.
        }
    }
    
    // --- PARSER, VALIDATOR, AND QUIZ START LOGIC ---
    function startManualQuiz() {
        const text = elements.quizDataInput.value.trim();
        if (!text) { alert('Please paste the quiz response into the box.'); return; }
        
        sessionStorage.removeItem('promptGenerated'); // Clear the flag now that we're using the data
        const parsedQuestions = transformParsedData_Legacy(parseQuizText_Legacy(text));
        
        if (!parsedQuestions || parsedQuestions.length === 0) {
            alert('Parsing Failed: Could not find any valid questions in the provided text. Please check the format matches the prompt examples.');
            return;
        }
        
        const validation = validateParsedData(parsedQuestions);
        if (!validation.isValid) {
            alert(`Quiz Validation Failed:\n\n${validation.error}`);
            return;
        }
        
        quizData = parsedQuestions;
        startQuiz();
    }
    
    function validateParsedData(questions) {
        for (let i = 0; i < questions.length; i++) {
            const q = questions[i];
            const qNum = i + 1;
            if (!q.question || q.question.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its main text.` };
            if (!q.options || q.options.length < 2) return { isValid: false, error: `Question ${qNum} has fewer than two options.` };
            if (typeof q.correctAnswerIndex !== 'number' || q.correctAnswerIndex < 0 || q.correctAnswerIndex >= q.options.length) {
                return { isValid: false, error: `Could not find a valid correct answer for Question ${qNum}. Check the 'Correct Answer' line.` };
            }
            if (!q.explanation || q.explanation.trim() === '') return { isValid: false, error: `Question ${qNum} is missing its explanation.` };
        }
        return { isValid: true };
    }
    
    function getActiveTopic() {
        if (!elements.topicGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-topic').value.trim() || "Quiz from Topic";
        if (!elements.textGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-subject-text').value.trim() || "Quiz from Text";
        if (!elements.imageGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-topic-image').value.trim() || "Quiz from Image";
        if (!elements.pdfGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-topic-pdf').value.trim() || "Quiz from PDF";
        return "Manually Parsed Quiz";
    }
    
    function getActiveSubject() {
        if (!elements.topicGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-subject-topic').value.trim();
        if (!elements.textGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-subject-text').value.trim();
        if (!elements.imageGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-subject-image').value.trim();
        if (!elements.pdfGeneratorWorkflow.classList.contains('hidden')) return document.getElementById('prompt-subject-pdf').value.trim();
        return "";
    }


    function transformParsedData_Legacy(parsedQuestions) {
        return parsedQuestions.map(q => {
            if (!q) return null;
            const cleanedOptions = q.options.map(opt => opt.replace(/^[a-zA-Z]\)\s*/, '').trim());
            const correctAnswerIndex = q.options.findIndex(opt => opt.trim().toLowerCase().startsWith(q.answer.toLowerCase() + ')'));
            
            if (correctAnswerIndex === -1) { console.error("Could not find correct answer for question:", q); return null; }
            
            let finalQuestionText = q.question;
            let statements = [];

            if (q.type === 'Statement' || q.question.includes('*')) {
                const parts = q.question.split(/Which of the above statements are correct\?/i);
                if (parts.length > 1) {
                    finalQuestionText = `Which of the above statements are correct?`;
                    statements = parts[0].split('*').map(s => s.trim()).filter(s => s);
                }
            } else if (q.type === 'Assertion-Reason') {
                 finalQuestionText = q.question.replace(/<br>/g, '\n');
            }

            return {
                question: finalQuestionText, options: cleanedOptions, correctAnswerIndex: correctAnswerIndex, explanation: q.explanation,
                topic: getActiveTopic(), difficulty: "N/A", statements: statements, image: null,
            };
        }).filter(Boolean);
    }

    function parseQuizText_Legacy(text) {
        if (!text || !text.trim()) return [];
        
        const questionBlocks = text.trim().split(/\n(?=\d+\.\s)/);

        return questionBlocks.map(block => {
            const fullBlock = block.trim();
            const headerMatch = fullBlock.match(/^\d+\.\s(.*?Questions)/);
            if (!headerMatch) return null;
            
            let data = { type: 'Unknown', question: '', options: [], answer: '', explanation: '' };
            
            if (headerMatch[1].includes('Assertion-Reason')) data.type = 'Assertion-Reason';
            else if (headerMatch[1].includes('Statement-Based')) data.type = 'Statement';
            else data.type = 'MCQ';

            const questionRegex = /Question:([\s\S]*?)Options:\n([\s\S]*?)Correct Answer:([\s\S]*?)(?:Explanation:([\s\S]*))?$/;
            const arRegex = /Assertion \(A\):([\s\S]*?)Reason \(R\):([\s\S]*?)Options:\n([\s\S]*?)Correct Answer:([\s\S]*?)(?:Explanation:([\s\S]*))?$/;
            const match = (data.type === 'Assertion-Reason') ? fullBlock.match(arRegex) : fullBlock.match(questionRegex);
            
            if (match) {
                if (data.type === 'Assertion-Reason') {
                    data.question = `Assertion (A): ${match[1].trim()}\nReason (R): ${match[2].trim()}`;
                    data.options = match[3].trim().split('\n').map(opt => opt.trim());
                    data.answer = match[4].trim().split(')')[0].trim();
                    data.explanation = (match[5] || 'No explanation provided.').trim();
                } else {
                    data.question = match[1].trim();
                    data.options = match[2].trim().split('\n').map(opt => opt.trim());
                    data.answer = match[3].trim().split(')')[0].trim();
                    data.explanation = (match[4] || 'No explanation provided.').trim();
                }
                return data;
            }
            return null;
        }).filter(Boolean);
    }
    
    // --- UTILITY & RESULTS FUNCTIONS ---
    async function restartQuiz() {
        sessionStorage.removeItem('promptGenerated');
        await dbHelper.clear();
        window.location.reload();
    }

    function formatQuizForCopy(indices) { 
        return indices.map(qIndex => { 
            const q = originalQuizData[qIndex]; 
            let questionText = `Question ${qIndex + 1}: ${q.question.replace(/<b>|<\/b>/g, '')}`; 
            if (q.statements && q.statements.length > 0) { 
                const statementText = q.statements.map(stmt => `* ${stmt}`).join('\n'); 
                questionText = `Question ${qIndex + 1}:\n${statementText}\n${q.question.replace(/<b>|<\/b>/g, '')}`; 
            } 
            const optionsText = q.options.map((opt, i) => `${String.fromCharCode(65 + i)}) ${opt}`).join('\n'); 
            const correctAnswerText = q.options[q.correctAnswerIndex]; 
            return `${questionText}\n\nOptions:\n${optionsText}\n\nCorrect Answer: ${correctAnswerText}\nExplanation: ${q.explanation}`; 
        }).join('\n\n---\n\n'); 
    }
    
    function copyQuizContent(bookmarksOnly) {
        const indicesToCopy = bookmarksOnly ? Array.from(bookmarkedQuestions) : Array.from(originalQuizData.keys());

        if (indicesToCopy.length === 0) {
            showPasteNotification(`🤔 No ${bookmarksOnly ? 'bookmarked ' : ''}questions to copy!`);
            return;
        }

        // --- Create the preamble with summary ---
        const totalQuestions = originalQuizData.length;
        const correctCount = userAnswers.filter(ans => ans.isCorrect).length;
        const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length;
        const skippedCount = totalQuestions - correctCount - incorrectCount;
        const percentage = totalQuestions > 0 ? (correctCount / totalQuestions) * 100 : 0;

        let preamble = `*QUIZ SUMMARY*\n`;
        preamble += `Topic: ${quizMetaData.topic || 'N/A'}\n`;
        if (quizMetaData.subject) {
            preamble += `Subject: ${quizMetaData.subject}\n`;
        }
        preamble += `--------------------\n`;
        preamble += `Score: ${correctCount} / ${totalQuestions} (${percentage.toFixed(0)}%)\n`;
        preamble += `Correct: ${correctCount}\n`;
        preamble += `Incorrect: ${incorrectCount}\n`;
        preamble += `Skipped: ${skippedCount}\n`;
        preamble += `--------------------\n\n`;

        // --- Format the questions ---
        const questionsText = formatQuizForCopy(indicesToCopy);
        
        // --- Combine and copy ---
        const fullTextToCopy = preamble + (bookmarksOnly ? '*BOOKMARKED QUESTIONS*\n\n' : '*ALL QUESTIONS*\n\n') + questionsText;
        copyTextToClipboard(fullTextToCopy).then(() => showPasteNotification(`✅ Summary & ${bookmarksOnly ? 'bookmarked ' : 'all '}questions copied!`));
    }


    function copyTextToClipboard(text) { return new Promise((resolve, reject) => { if (navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(text).then(resolve).catch(err => { console.warn('Modern clipboard API failed, falling back.', err); legacyCopy(reject); }); } else { legacyCopy(reject); } function legacyCopy(onFail) { const textArea = document.createElement("textarea"); textArea.value = text; textArea.style.position = "fixed"; textArea.style.top = "-9999px"; document.body.appendChild(textArea); textArea.focus(); textArea.select(); try { document.execCommand('copy') ? resolve() : onFail(new Error('Legacy copy command failed.')); } catch (err) { console.error('Legacy copy failed.', err); onFail(err); } finally { document.body.removeChild(textArea); } } }).catch(() => { showManualCopyModal(text); throw new Error("Manual intervention required for copy."); }); }
    function showManualCopyModal(text) { elements.manualCopyTextarea.value = text; elements.manualCopyModalOverlay.classList.remove('hidden'); elements.manualCopyTextarea.select(); elements.manualCopyTextarea.focus(); }
    function showPasteNotification(message) { elements.pasteNotification.textContent=message;elements.pasteNotification.classList.add('show');setTimeout(()=>elements.pasteNotification.classList.remove('show'),3000)}
    function toggleTheme(){document.body.classList.toggle('dark-mode');const isDarkMode=document.body.classList.contains('dark-mode');localStorage.setItem('quizTheme',isDarkMode?'dark':'light');elements.themeToggleBtn.textContent=isDarkMode?'☀️':'🌙'}
    function applyInitialTheme(){if(localStorage.getItem('quizTheme')==='dark'){document.body.classList.add('dark-mode');elements.themeToggleBtn.textContent='☀️'}}
    
    function shareOnWhatsApp() {
        const totalQuestions = originalQuizData.length;
        if (totalQuestions === 0) return;

        const correctCount = userAnswers.filter(ans => ans.isCorrect).length;
        const incorrectCount = userAnswers.filter(ans => ans.status === 'answered' && !ans.isCorrect).length;
        const skippedCount = totalQuestions - correctCount - incorrectCount;
        const percentage = (correctCount / totalQuestions) * 100;
        
        let remark = "Keep Practicing!";
        if (percentage >= 90) remark = "Excellent Work! 🤩";
        else if (percentage >= 75) remark = "Great Job! 👍";
        else if (percentage >= 50) remark = "Good Effort! 😊";
        
        const topic = originalQuizData[0]?.topic || 'a fun quiz';
        const urlToShare = window.location.href;

        const messageParts = [
            `*🏆 My Quiz Results on QUIZYATRA! 🏆*`,
            `\nI just took a quiz on *"${topic}"* and here's how I did:`,
            `\n*Overall Score: ${correctCount} / ${totalQuestions}*`,
            `-----------------------------------`,
            `*Detailed Breakdown:*`,
            `✅ Correct: ${correctCount}`,
            `❌ Incorrect: ${incorrectCount}`,
            `⏭️ Skipped: ${skippedCount}`,
            `📊 Percentage: *${percentage.toFixed(0)}%*`,
            `🗣️ Remark: _${remark}_`,
            `-----------------------------------`,
            `Think you can do better? Create your own quizzes on *QUIZYATRA* - _Quiz Se Kro Success Yatra!_ 🚀`,
            `\n👉 ${urlToShare}`
        ];

        const fullText = messageParts.join('\n');
        const whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(fullText)}`;
        window.open(whatsappUrl, '_blank');
    }

    function openTelegramChannel() { const username = elements.resultsPageTelegramInput.value.trim(); if (!username) { alert("Please enter a Telegram username."); return; } const channel = username.replace(/^@/, ''); const url = `https://t.me/${channel}`; window.open(url, '_blank'); }
    async function generatePDF() { const { jsPDF } = window.jspdf; const doc = new jsPDF(); let y = 15; const pageHeight = doc.internal.pageSize.height; const margin = 15; const checkY = (inc) => { if (y + inc > pageHeight - margin) { doc.addPage(); y = margin; } }; doc.setFontSize(18).setFont(undefined, 'bold').text("Quiz Results", margin, y); y += 10; doc.setFontSize(12).setFont(undefined, 'normal'); const summaryDetails = Array.from(elements.quizSummaryDetails.querySelectorAll('.summary-item')).map(item => `${item.querySelector('.summary-label').textContent}: ${item.querySelector('.summary-value').textContent}`).join(' | '); doc.text(elements.scoreSummary.textContent, margin, y); y += 7; let summaryLines = doc.splitTextToSize(summaryDetails, 180); doc.text(summaryLines, margin, y); y += summaryLines.length * 5 + 10; doc.line(margin, y - 5, doc.internal.pageSize.width - margin, y - 5); originalQuizData.forEach((q, i) => { checkY(20); doc.setFontSize(14).setFont(undefined, 'bold'); const questionText = doc.splitTextToSize(`Q${i + 1}: ${q.question.replace(/<[^>]*>/g, '')}`, 180); doc.text(questionText, margin, y); y += questionText.length * 6; doc.setFontSize(11).setFont(undefined, 'normal'); q.options.forEach((opt, oi) => { checkY(7); let prefix = '  '; if(oi === q.correctAnswerIndex) { doc.setTextColor(34, 139, 34); prefix = '✔ '; } if(userAnswers[i].selected === oi && !userAnswers[i].isCorrect) { doc.setTextColor(220, 20, 60); prefix = '✖ '; } doc.text(doc.splitTextToSize(`${prefix}${opt}`, 175), margin + 5, y); y += 6; doc.setTextColor(0, 0, 0); }); y += 5; checkY(15); doc.setFont(undefined, 'bold').text("Explanation:", margin, y); y += 5; doc.setFont(undefined, 'normal'); const explanationText = doc.splitTextToSize(q.explanation.replace(/<[^>]*>/g, ''), 180); checkY(explanationText.length * 5 + 10); doc.text(explanationText, margin, y); y += explanationText.length * 5 + 10; }); doc.save(`Quiz_Results_${new Date().toISOString().slice(0,10)}.pdf`); }

    // --- QUIZ PLAYER LOGIC ---
    function resetAndStartQuestionTimer() {
        clearInterval(timerId);
        questionStartTime = new Date();
        const emojiSequence = [elements.faces.happy, elements.faces.worried, elements.faces.sad, elements.faces.crying];
        const updateTimerDisplay = () => {
            if (!questionStartTime) return;
            const elapsedTime = Math.round((new Date() - questionStartTime) / 1000);
            const minutes = Math.floor(elapsedTime / 60);
            const seconds = elapsedTime % 60;
            elements.timerText.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
            const emojiIntervalIndex = Math.floor(elapsedTime / 15);
            const currentEmoji = emojiSequence[emojiIntervalIndex % emojiSequence.length];
            if (currentEmoji && !currentEmoji.classList.contains('visible')) {
                emojiSequence.forEach(face => face.classList.remove('visible'));
                currentEmoji.classList.add('visible');
            }
        };
        updateTimerDisplay();
        timerId = setInterval(updateTimerDisplay, 1000);
    }
    function startQuiz(){showScreen('player');quizStartTime=new Date();currentQuestionIndex=0;userAnswers=quizData.map(()=>({selected:null,isCorrect:null,status:'unseen'}));bookmarkedQuestions.clear();originalQuizData=JSON.parse(JSON.stringify(quizData));quizMetaData={topic:getActiveTopic(),subject:getActiveSubject()};loadQuestion(0)}
    function loadQuestion(index){if(index<0||index>=originalQuizData.length)return;currentQuestionIndex=index;selectedOptionIndex=null;const question=originalQuizData[currentQuestionIndex];const answer=userAnswers[currentQuestionIndex];if(answer.status==='answered'){clearInterval(timerId);elements.timerText.textContent="--:--";Object.values(elements.faces).forEach(face=>face.classList.remove('visible'))}else{resetAndStartQuestionTimer()}updateQuestionUI(question);updateOptionsAndExplanationState();updateQuizActions()}
    function updateQuestionUI(q){elements.questionTopic.textContent=q.topic||"General";elements.progress.textContent=`Question ${currentQuestionIndex+1} / ${originalQuizData.length}`;elements.questionText.innerHTML=q.question.replace(/\n/g, '<br>');elements.bookmarkBtn.classList.toggle('bookmarked',bookmarkedQuestions.has(currentQuestionIndex));elements.statementsList.innerHTML=q.statements?.map(stmt=>`<p>• ${stmt}</p>`).join('')||'';elements.optionsContainer.innerHTML='';q.options.forEach((optionText,i)=>{const optionDiv=document.createElement('div');optionDiv.className='option';optionDiv.dataset.index=i;optionDiv.innerHTML=`<span class="option-text">${optionText}</span><div class="option-feedback"><span class="user-choice-emoji"></span><span class="feedback-icon"></span></div>`;optionDiv.addEventListener('click',()=>selectOption(i));elements.optionsContainer.appendChild(optionDiv)});if(userAnswers[currentQuestionIndex].status==='answered'){elements.explanationText.innerHTML=`<p>${q.explanation}</p>`}}
    function updateOptionsAndExplanationState(){
        const answer = userAnswers[currentQuestionIndex];
        const question = originalQuizData[currentQuestionIndex];
        const correctEmojis = ['🥳', '🎉', '🤩', '👍', '💯'];
        const incorrectEmojis = ['🤔', '😟', '🤨', '🤦‍♂️', '❌'];

        document.querySelectorAll('.option').forEach((optionDiv, i) => {
            if (answer.status === 'answered') {
                optionDiv.classList.add('disabled');

                if (i === question.correctAnswerIndex) {
                    optionDiv.classList.add('correct');
                    optionDiv.querySelector('.feedback-icon').textContent = '✔️';
                }

                if (i === answer.selected) {
                    const userChoiceEmoji = optionDiv.querySelector('.user-choice-emoji');
                    if (answer.isCorrect) {
                        userChoiceEmoji.textContent = correctEmojis[Math.floor(Math.random() * correctEmojis.length)];
                    } else {
                        optionDiv.classList.add('incorrect');
                        optionDiv.querySelector('.feedback-icon').textContent = '❌';
                        userChoiceEmoji.textContent = incorrectEmojis[Math.floor(Math.random() * incorrectEmojis.length)];
                    }
                    userChoiceEmoji.classList.add('visible');
                }
            }
        });
        elements.explanationContainer.classList.toggle('hidden', answer.status !== 'answered');
    }
    function updateQuizActions(){elements.quizActions.innerHTML='';const topRow=document.createElement('div');topRow.className='quiz-actions-row';const middleRow=document.createElement('div');middleRow.className='quiz-actions-row';const bottomRow=document.createElement('div');bottomRow.className='quiz-actions-row quiz-actions-row-bottom';if(userAnswers[currentQuestionIndex].status!=='answered'){const checkBtn=document.createElement('button');checkBtn.id='check-answer-btn';checkBtn.className='btn';checkBtn.textContent='Check Answer';checkBtn.disabled=selectedOptionIndex===null;checkBtn.addEventListener('click',checkAnswer);topRow.appendChild(checkBtn)}else{topRow.appendChild(document.createElement('span'))}const nextBtn=document.createElement('button');nextBtn.id='next-question-btn';nextBtn.className='btn';nextBtn.textContent='Next';nextBtn.disabled=currentQuestionIndex===originalQuizData.length-1;nextBtn.addEventListener('click',()=>loadQuestion(currentQuestionIndex+1));topRow.appendChild(nextBtn);const prevBtn=document.createElement('button');prevBtn.id='prev-question-btn';prevBtn.className='btn btn-secondary';prevBtn.textContent='Previous';prevBtn.disabled=currentQuestionIndex===0;prevBtn.addEventListener('click',()=>loadQuestion(currentQuestionIndex-1));middleRow.appendChild(prevBtn);if(userAnswers[currentQuestionIndex].status!=='answered'){const skipBtn=document.createElement('button');skipBtn.id='skip-question-btn';skipBtn.className='btn';skipBtn.textContent='Skip';skipBtn.addEventListener('click',handleSkip);middleRow.appendChild(skipBtn)}else{middleRow.appendChild(document.createElement('span'))}const submitBtn=document.createElement('button');submitBtn.id='submit-quiz-btn';submitBtn.className='btn btn-danger btn-full-width';submitBtn.textContent='Submit Quiz';submitBtn.addEventListener('click',forceSubmitQuiz);bottomRow.appendChild(submitBtn);elements.quizActions.appendChild(topRow);elements.quizActions.appendChild(middleRow);elements.quizActions.appendChild(bottomRow)}
    function handleBookmark(){bookmarkedQuestions.has(currentQuestionIndex)?bookmarkedQuestions.delete(currentQuestionIndex):bookmarkedQuestions.add(currentQuestionIndex);elements.bookmarkBtn.classList.toggle('bookmarked')}
    function handleSkip(){if(userAnswers[currentQuestionIndex].status==='unseen'){userAnswers[currentQuestionIndex].status='skipped'}if(currentQuestionIndex<originalQuizData.length-1){loadQuestion(currentQuestionIndex+1)}else{const firstUnanswered=userAnswers.findIndex(ans=>ans.status!=='answered');if(firstUnanswered!==-1)loadQuestion(firstUnanswered);else forceSubmitQuiz()}}
    function forceSubmitQuiz(){if(confirm('Are you sure you want to end the quiz now? All unanswered questions will be marked as skipped.')){if(timerId) clearInterval(timerId);userAnswers.forEach((answer,index)=>{if(answer.status==='unseen')userAnswers[index].status='skipped'});showResults()}}
    function selectOption(index){if(userAnswers[currentQuestionIndex].status==='answered')return;selectedOptionIndex=index;document.querySelectorAll('.option').forEach((opt,i)=>opt.classList.toggle('selected',i===index));document.getElementById('check-answer-btn').disabled=false}
    function checkAnswer(){const question=originalQuizData[currentQuestionIndex];const isCorrect=selectedOptionIndex===question.correctAnswerIndex;userAnswers[currentQuestionIndex]={selected:selectedOptionIndex,isCorrect:isCorrect,status:'answered'};updateQuestionUI(originalQuizData[currentQuestionIndex]);updateOptionsAndExplanationState();updateQuizActions()}
    function showResults(){showScreen('results');if(timerId) clearInterval(timerId);const totalQuestions=originalQuizData.length;const correctCount=userAnswers.filter(ans=>ans.isCorrect).length;const incorrectCount=userAnswers.filter(ans=>ans.status==='answered'&&!ans.isCorrect).length;const skippedCount=userAnswers.filter(ans=>ans.status==='skipped'||ans.status==='unseen').length;const percentage=totalQuestions>0?(correctCount/totalQuestions)*100:0;let remark=percentage>=90?"Excellent!":percentage>=75?"Great Job!":percentage>=50?"Good Effort!":"Needs Improvement";const timeDiff=Math.round(((new Date())-quizStartTime)/1000);const timeTaken=`${String(Math.floor(timeDiff/60)).padStart(2,'0')}:${String(timeDiff%60).padStart(2,'0')}`;elements.scoreSummary.textContent=`You scored ${correctCount} out of ${totalQuestions}!`;elements.quizSummaryDetails.innerHTML=`<div class="summary-item"><span class="summary-label">Performance</span><span class="summary-value remark">${remark}</span></div><div class="summary-item"><span class="summary-label">Score</span><span class="summary-value">${correctCount} / ${totalQuestions} (${percentage.toFixed(0)}%)</span></div><div class="summary-item"><span class="summary-label">Correct</span><span class="summary-value" style="color: var(--correct-color);">${correctCount}</span></div><div class="summary-item"><span class="summary-label">Incorrect</span><span class="summary-value" style="color: var(--incorrect-color);">${incorrectCount}</span></div><div class="summary-item"><span class="summary-label">Skipped</span><span class="summary-value" style="color: var(--skipped-color);">${skippedCount}</span></div><div class="summary-item"><span class="summary-label">Time Taken</span><span class="summary-value">${timeTaken}</span></div><div class="summary-item"><span class="summary-label">Topic</span><span class="summary-value">${originalQuizData[0]?.topic||'N/A'}</span></div><div class="summary-item"><span class="summary-label">Difficulty</span><span class="summary-value">${originalQuizData[0]?.difficulty||'N/A'}</span></div>`;elements.resultsReview.innerHTML=originalQuizData.map((q,i)=>{const answer=userAnswers[i];const optionsHtml=q.options.map((opt,oi)=>{let classes='result-option';if(answer.status==='answered'&&oi===answer.selected)classes+=' user-selected';if(oi===q.correctAnswerIndex)classes+=' correct-answer';return`<li class="${classes}">${opt}</li>`}).join('');return`<div class="result-item"><p class="result-question"><strong>Q${i + 1}:</strong> ${q.question.replace(/<[^>]*>/g, '')}<span class="bookmark-indicator ${bookmarkedQuestions.has(i)?'visible':''}">⭐</span></p><ul class="result-options-list">${optionsHtml}</ul><div class="result-explanation"><h5>Explanation</h5><p>${q.explanation.replace(/<[^>]*>/g, '')}</p></div></div>`}).join('')}
});
</script>

</body>
</html>